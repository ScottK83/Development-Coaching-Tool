function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function showToast(e,t=2e3){const n=document.createElement("div");n.textContent=e,n.style.cssText="\n        position: fixed;\n        bottom: 20px;\n        right: 20px;\n        background: #28a745;\n        color: white;\n        padding: 12px 20px;\n        border-radius: 4px;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n        font-size: 14px;\n        z-index: 10000;\n        animation: slideIn 0.3s ease-out;\n    ",document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideOut 0.3s ease-out",setTimeout(()=>n.remove(),300)},t)}function showOnlySection(e){[{id:"coachingForm",conditional:!1},{id:"resultsSection",conditional:!1},{id:"dashboardSection",conditional:!1},{id:"historySection",conditional:!1},{id:"tipsManagementSection",conditional:!1}].forEach(t=>{const n=document.getElementById(t.id);n&&(n.style.display=t.id===e?"block":"none")});const t=document.getElementById("customNotesSection");t&&(t.style.display="coachingForm"===e?"block":"none")}function exportToPDF(){window.print()}const TARGETS={driver:{scheduleAdherence:{min:93},cxRepOverall:{min:80},fcr:{min:70},overallExperience:{min:80},transfers:{max:6},overallSentiment:{min:88},positiveWord:{min:86},negativeWord:{min:83},managingEmotions:{min:95},aht:{max:440},acw:{max:60},holdTime:{max:30},reliability:{max:16}}};let customTips={},serverTips={},userTips={},hiddenTips={},tipOrder={},uploadHistory=[];function detectTimePeriod(e,t){const n=new Date(e),i=new Date(t),o=Math.ceil((i-n)/864e5);if(o>=365&&0===n.getMonth()&&11===i.getMonth())return`${n.getFullYear()}`;const r=Math.floor(n.getMonth()/3)+1;if(o>=85&&o<=95)return`Q${r} ${n.getFullYear()}`;if(o>=27&&o<=32&&n.getMonth()===i.getMonth()){return n.toLocaleString("default",{month:"long",year:"numeric"})}if(7===o){return`Week ${Math.ceil((n.getDate()+new Date(n.getFullYear(),n.getMonth(),1).getDay())/7)} ${n.toLocaleString("default",{month:"short"})} ${n.getFullYear()}`}return`${e} to ${t}`}function loadUploadHistory(){try{const e=localStorage.getItem("uploadHistory");return e?JSON.parse(e):[]}catch(e){return console.error("Error loading upload history:",e),[]}}function saveUploadHistory(e){try{localStorage.setItem("uploadHistory",JSON.stringify(e))}catch(e){console.error("Error saving upload history:",e)}}function loadTipOrder(){try{const e=localStorage.getItem("tipOrder");return e?JSON.parse(e):{}}catch(e){return console.error("Error loading tip order:",e),{}}}function saveTipOrder(e){try{localStorage.setItem("tipOrder",JSON.stringify(e))}catch(e){console.error("Error saving tip order:",e)}}const AREA_NAMES={scheduleAdherence:"Schedule Adherence",cxRepOverall:"Customer Experience",fcr:"First Call Resolution",overallExperience:"Overall Experience",transfers:"Transfers",overallSentiment:"Overall Sentiment",positiveWord:"Positive Word Choice",negativeWord:"Avoid Negative Word Choice",managingEmotions:"Managing Emotions",aht:"Average Handle Time",acw:"After Call Work",holdTime:"Hold Time",reliability:"Reliability"},IMPROVEMENT_TIPS={scheduleAdherence:"Schedule Adherence: Focus on being present for all scheduled shifts. This is foundational to your team relying on you.",cxRepOverall:"Customer Experience: Every interaction is an opportunity to exceed expectations. Work on consistency and attention to detail.",fcr:"First Call Resolution: Before transferring, confirm you've exhausted available resources. Take time to understand the full issue first.",transfers:"Transfers: Reduce transfers by building your product knowledge and taking time to fully understand customer needs before responding.",overallSentiment:"Overall Sentiment: Let your enthusiasm for helping customers shine through. Your tone sets the temperature for the conversation.",positiveWord:"Positive Word Choice: Use constructive language. Say 'Let me find out' instead of 'I don't know' to maintain customer confidence.",negativeWord:"Negative Word Choice: Avoid language that sounds dismissive. Replace 'You'll have to...' with 'Let me help you...'",managingEmotions:"Managing Emotions: You're doing great here! Keep maintaining composure even during challenging interactions.",aht:"Average Handle Time: Focus on efficiency without rushing. Prepare your responses, but don't skip necessary steps.",acw:"After Call Work: Complete your documentation promptly. This keeps you available for the next customer and maintains accuracy.",holdTime:"Hold Time: Minimize hold time by gathering information upfront. It improves customer experience and efficiency.",reliability:"Reliability: Your availability is crucial. Work toward reducing unexpected absences and maintaining consistent attendance."};function generateEmailContent(e,t){const n=e.trim().split(" "),i=n[0],o=n[n.length-1];return{to:`${i.toLowerCase()}.${o.toLowerCase()}@aps.com`,subject:"Quick Check-In: Let's Chat About Your Metrics!",body:t}}async function loadServerTips(){try{const e=await fetch("tips.csv"),t=await e.text(),n=t.split("\n").map(e=>e.trim()).filter(e=>e).slice(1),i={};return n.forEach(e=>{const t=e.match(/^([^,]+),"?([^"]*)"?$/);if(t){const e=t[1].trim(),n=t[2].trim();i[e]||(i[e]=[]),i[e].push(n)}}),i}catch(e){return console.error("Error loading server tips:",e),{}}}function loadUserTips(){try{const e=localStorage.getItem("userCustomTips");return e?JSON.parse(e):{}}catch(e){return console.error("Error loading user tips:",e),{}}}function loadHiddenTips(){try{const e=localStorage.getItem("hiddenTips");return e?JSON.parse(e):{}}catch(e){return console.error("Error loading hidden tips:",e),{}}}function saveUserTips(e){try{localStorage.setItem("userCustomTips",JSON.stringify(e))}catch(e){console.error("Error saving user tips:",e),alert("Warning: Could not save custom tips. Storage may be full.")}}function saveHiddenTips(e){try{localStorage.setItem("hiddenTips",JSON.stringify(e))}catch(e){console.error("Error saving hidden tips:",e)}}function mergeTips(){const e={},t=hiddenTips||{};Object.entries(serverTips).forEach(([n,i])=>{e[n]=i.filter(e=>!(t[n]||[]).includes(e))}),Object.entries(userTips).forEach(([n,i])=>{e[n]||(e[n]=[]);const o=i.filter(e=>!(t[n]||[]).includes(e));e[n].push(...o)}),Object.keys(e).forEach(t=>{const n=e[t]||[],i=tipOrder[t]||[],o={};n.forEach(e=>{o[e]=(o[e]||0)+1});const r=[];i.forEach(e=>{o[e]>0&&(r.push(e),o[e]--)}),n.forEach(e=>{o[e]>0&&(r.push(e),o[e]--)}),e[t]=r,tipOrder[t]=r}),customTips=e,saveTipOrder(tipOrder)}function showTipsManagement(){const e=document.getElementById("metricSelect");e.innerHTML='<option value="">-- Choose a metric --</option>',Object.keys(AREA_NAMES).forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=AREA_NAMES[t],e.appendChild(n)}),document.getElementById("tipsManagementContent").innerHTML='<p style="color: #999; font-style: italic; text-align: center; padding: 40px;">Select a metric from the dropdown above to view and manage its tips.</p>',showOnlySection("tipsManagementSection")}function showMetricTips(e){if(!e)return void(document.getElementById("tipsManagementContent").innerHTML='<p style="color: #999; font-style: italic; text-align: center; padding: 40px;">Select a metric from the dropdown above to view and manage its tips.</p>');const t=document.getElementById("tipsManagementContent"),n=AREA_NAMES[e],i=customTips[e]||[];let o=`\n        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: white;">\n            <h3 style="color: #003DA5; margin-bottom: 15px;">${n}</h3>\n            \n            <div id="tips-${e}" style="margin-bottom: 15px;">\n    `;0===i.length?o+='<p style="color: #999; font-style: italic;">No tips available for this metric.</p>':i.forEach((t,n)=>{o+=`\n                <div style="display: flex; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; align-items: start;">\n                    <div style="flex: 1;">\n                        <textarea id="tip-${e}-${n}" style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${t}</textarea>\n                    </div>\n                    <button onclick="saveTipEdit('${e}', ${n})" style="background: #28a745; color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer;">üíæ Save</button>\n                    <button onclick="deleteTip('${e}', ${n})" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer;">üóëÔ∏è Delete</button>\n                </div>\n            `}),o+=`\n            </div>\n            \n            <div style="margin-top: 15px;">\n                <textarea id="newTip-${e}" placeholder="Add a new tip for ${n}..." style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>\n                <button onclick="addNewTip('${e}')" style="background: #007bff; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer; margin-top: 5px;">‚ûï Add Tip</button>\n            </div>\n        </div>\n    `,t.innerHTML=o}function addNewTip(e){const t=document.getElementById(`newTip-${e}`);if(!t)return;const n=t.value.trim();n?(userTips[e]||(userTips[e]=[]),userTips[e].push(n),tipOrder[e]||(tipOrder[e]=customTips[e]?[...customTips[e]]:[]),tipOrder[e].push(n),saveTipOrder(tipOrder),saveUserTips(userTips),mergeTips(),showMetricTips(e),showToast("‚úÖ Tip added"),document.getElementById(`newTip-${e}`).value=""):alert("Please enter a tip before adding.")}function saveTipEdit(e,t){const n=document.getElementById(`tip-${e}-${t}`);if(!n)return;const i=n.value.trim();if(!i)return void alert("Tip cannot be empty. Use delete if you want to remove it.");const o=(customTips[e]||[])[t];if((serverTips[e]||[]).includes(o)){hiddenTips[e]||(hiddenTips[e]=[]),hiddenTips[e].includes(o)||hiddenTips[e].push(o),userTips[e]||(userTips[e]=[]);const t=userTips[e].indexOf(o);-1!==t?userTips[e][t]=i:userTips[e].includes(i)||userTips[e].push(i)}else{userTips[e]||(userTips[e]=[]);const t=userTips[e].indexOf(o);-1!==t?userTips[e][t]=i:userTips[e].includes(i)||userTips[e].push(i)}tipOrder[e]||(tipOrder[e]=customTips[e]?[...customTips[e]]:[]),tipOrder[e][t]=i,saveTipOrder(tipOrder),saveHiddenTips(hiddenTips),saveUserTips(userTips),mergeTips(),showMetricTips(e),showToast("‚úÖ Tip updated")}function deleteTip(e,t){if(!confirm("Are you sure you want to delete this tip?"))return;const n=customTips[e]||[],i=n[t];if(void 0===i)return void alert("Tip not found.");n.splice(t,1);const o=serverTips[e]||[],r=n||[];hiddenTips[e]||(hiddenTips[e]=[]),hiddenTips[e].includes(i)||hiddenTips[e].push(i),userTips[e]=r.filter(e=>!o.includes(e)),tipOrder[e]||(tipOrder[e]=customTips[e]?[...customTips[e]]:[]),tipOrder[e].splice(t,1),saveTipOrder(tipOrder),saveHiddenTips(hiddenTips),saveUserTips(userTips),mergeTips(),showMetricTips(e),showToast("‚úÖ Tip deleted")}function getRandomTip(e){if(customTips[e]&&customTips[e].length>0){const t=customTips[e];return t[Math.floor(Math.random()*t.length)]}return IMPROVEMENT_TIPS[e]||`Focus on improving ${e}`}function identifyStrugglingAreas(e){const t=[];return[{key:"scheduleAdherence",value:e.scheduleAdherence,target:TARGETS.driver.scheduleAdherence},{key:"cxRepOverall",value:e.cxRepOverall,target:TARGETS.driver.cxRepOverall},{key:"fcr",value:e.fcr,target:TARGETS.driver.fcr},{key:"overallExperience",value:e.overallExperience,target:TARGETS.driver.overallExperience},{key:"transfers",value:e.transfers,target:TARGETS.driver.transfers},{key:"overallSentiment",value:e.overallSentiment,target:TARGETS.driver.overallSentiment},{key:"positiveWord",value:e.positiveWord,target:TARGETS.driver.positiveWord},{key:"negativeWord",value:e.negativeWord,target:TARGETS.driver.negativeWord},{key:"managingEmotions",value:e.managingEmotions,target:TARGETS.driver.managingEmotions},{key:"aht",value:e.aht,target:TARGETS.driver.aht},{key:"acw",value:e.acw,target:TARGETS.driver.acw},{key:"holdTime",value:e.holdTime,target:TARGETS.driver.holdTime},{key:"reliability",value:e.reliability,target:TARGETS.driver.reliability}].forEach(e=>{if(!("fcr"!==e.key&&"cxRepOverall"!==e.key&&"overallExperience"!==e.key||""!==e.value&&null!==e.value&&void 0!==e.value))return;const n=e.target,i="min"in n;(i&&e.value<n.min||!i&&e.value>n.max)&&t.push(e.key)}),t}function getEmployeeHistory(e){try{return JSON.parse(localStorage.getItem("coachingHistory")||"{}")[e]||[]}catch(e){return console.error("Error reading history:",e),[]}}function saveToHistory(e,t,n=null,i=null){try{const o=JSON.parse(localStorage.getItem("coachingHistory")||"{}");o[e]||(o[e]=[]),o[e].push({date:(new Date).toISOString(),dateRange:i||"",strugglingAreas:t,metrics:n}),localStorage.setItem("coachingHistory",JSON.stringify(o))}catch(o){if("QuotaExceededError"===o.name)if(console.warn("Storage quota exceeded, attempting cleanup..."),confirm("‚ö†Ô∏è Storage is full! Would you like to keep only the last 15 sessions per employee and try again?"))try{const o=JSON.parse(localStorage.getItem("coachingHistory")||"{}");Object.keys(o).forEach(e=>{o[e].length>15&&(o[e]=o[e].slice(-15))}),localStorage.setItem("coachingHistory",JSON.stringify(o)),o[e]||(o[e]=[]),o[e].push({date:(new Date).toISOString(),dateRange:i||"",strugglingAreas:t,metrics:n}),localStorage.setItem("coachingHistory",JSON.stringify(o)),console.log("‚úÖ Storage cleaned up and data saved successfully")}catch(e){console.error("Cleanup failed:",e),alert("‚ùå Could not save coaching history even after cleanup. Please export your data and clear history.")}else alert("‚ùå Data not saved. Please clear some history to continue.");else console.error("Error saving history:",o),alert("Warning: Could not save coaching history. Error: "+o.message)}}function getAllHistory(){try{return JSON.parse(localStorage.getItem("coachingHistory")||"{}")}catch(e){return console.error("Error reading all history:",e),{}}}function clearAllHistory(){localStorage.removeItem("coachingHistory"),alert("All history cleared!"),location.reload()}function deleteSession(e,t){const n=getAllHistory();n[e]&&(n[e].splice(t,1),0===n[e].length&&delete n[e],localStorage.setItem("coachingHistory",JSON.stringify(n)),showEmployeeDashboard())}function diagnoseTrends(e){const t=getEmployeeHistory(e);if(0===t.length)return void alert("No coaching history for this employee.");const n=t.sort((e,t)=>new Date(e.date)-new Date(t.date));let i=`\n        <div style="max-width: 1000px; margin: 20px auto;">\n            <h2 style="color: #003DA5; margin-bottom: 20px;">üìä Trend Analysis: ${escapeHtml(e)}</h2>\n            <p style="color: #666; margin-bottom: 30px;">Tracking ${n.length} coaching session${n.length>1?"s":""}</p>\n    `;[{key:"scheduleAdherence",name:"Schedule Adherence",unit:"%",target:TARGETS.driver.scheduleAdherence,isMin:!0},{key:"cxRepOverall",name:"CX Rep Overall",unit:"%",target:TARGETS.driver.cxRepOverall,isMin:!0},{key:"fcr",name:"First Call Resolution",unit:"%",target:TARGETS.driver.fcr,isMin:!0},{key:"overallExperience",name:"Overall Experience",unit:"%",target:TARGETS.driver.overallExperience,isMin:!0},{key:"transfers",name:"Transfers",unit:"%",target:TARGETS.driver.transfers,isMin:!1},{key:"overallSentiment",name:"Overall Sentiment",unit:"%",target:TARGETS.driver.overallSentiment,isMin:!0},{key:"positiveWord",name:"Positive Word",unit:"%",target:TARGETS.driver.positiveWord,isMin:!0},{key:"negativeWord",name:"Negative Word",unit:"%",target:TARGETS.driver.negativeWord,isMin:!0},{key:"managingEmotions",name:"Managing Emotions",unit:"%",target:TARGETS.driver.managingEmotions,isMin:!0},{key:"aht",name:"AHT",unit:"s",target:TARGETS.driver.aht,isMin:!1},{key:"acw",name:"ACW",unit:"s",target:TARGETS.driver.acw,isMin:!1},{key:"holdTime",name:"Hold Time",unit:"s",target:TARGETS.driver.holdTime,isMin:!1},{key:"reliability",name:"Reliability",unit:" hrs",target:TARGETS.driver.reliability,isMin:!1}].forEach(e=>{const t=n.filter(t=>t.metrics&&void 0!==t.metrics[e.key]&&0!==t.metrics[e.key]).map(t=>({date:new Date(t.date).toLocaleDateString(),dateRange:t.dateRange||"",value:t.metrics[e.key],wasCoached:t.strugglingAreas.includes(e.key)}));if(0===t.length)return;const o=e.isMin?e.target.min:e.target.max,r=t[0].value,a=t[t.length-1].value;let l="‚Üí",s="#666",d="No change";if(t.length>1){const t=a-r;e.isMin?t>0?(l="üìà",s="#28a745",d=`Improving (+${t.toFixed(2)}${e.unit})`):t<0&&(l="üìâ",s="#dc3545",d=`Declining (${t.toFixed(2)}${e.unit})`):t<0?(l="üìà",s="#28a745",d=`Improving (${t.toFixed(2)}${e.unit})`):t>0&&(l="üìâ",s="#dc3545",d=`Declining (+${t.toFixed(2)}${e.unit})`)}const c=e.isMin?a>=o:a<=o,m=c?"‚úÖ Meeting target":"‚ö†Ô∏è Below target",p=Math.min(...t.map(e=>e.value)),u=Math.max(...t.map(e=>e.value))-p||1;i+=`\n            <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">\n                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">\n                    <h3 style="margin: 0; color: #003DA5;">${e.name}</h3>\n                    <div style="text-align: right;">\n                        <span style="font-size: 1.5em;">${l}</span>\n                        <div style="color: ${s}; font-weight: bold;">${d}</div>\n                        <div style="color: ${c?"#28a745":"#dc3545"}; font-size: 0.9em;">${m}</div>\n                    </div>\n                </div>\n                <div style="margin-bottom: 15px;">\n                    <strong>Target:</strong> ${e.isMin?"‚â•":"‚â§"}${o}${e.unit} | \n                    <strong>Current:</strong> ${a}${e.unit}\n                </div>\n                \n                \x3c!-- Visual Chart --\x3e\n                <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 15px;">\n                    <div style="display: flex; align-items: flex-end; gap: 5px; height: 150px; border-bottom: 2px solid #ddd; padding-bottom: 5px;">\n        `,t.forEach((n,o)=>{const r=u>0?(n.value-p)/u*100:50,a=o>0&&(e.isMin?n.value>t[o-1].value:n.value<t[o-1].value),l=o>0&&(e.isMin?n.value<t[o-1].value:n.value>t[o-1].value),s=n.wasCoached?"#ffc107":a?"#28a745":l?"#dc3545":"#007bff",d=n.dateRange||n.date.substring(0,5);i+=`\n                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">\n                    <div style="font-weight: bold; font-size: 0.85em; margin-bottom: 3px; color: ${s};">${n.value}${e.unit}</div>\n                    <div style="width: 100%; height: ${r}%; min-height: 10px; background: ${s}; border-radius: 4px 4px 0 0; transition: all 0.3s;"></div>\n                    <div style="font-size: 0.75em; color: #666; margin-top: 5px; writing-mode: vertical-rl; transform: rotate(180deg);">${d}</div>\n                </div>\n            `}),i+='\n                    </div>\n                    <div style="margin-top: 10px; font-size: 0.85em; color: #666;">\n                        <span style="display: inline-block; width: 12px; height: 12px; background: #ffc107; border-radius: 2px; margin-right: 5px;"></span>Coached\n                        <span style="display: inline-block; width: 12px; height: 12px; background: #28a745; border-radius: 2px; margin-left: 15px; margin-right: 5px;"></span>Improving\n                        <span style="display: inline-block; width: 12px; height: 12px; background: #dc3545; border-radius: 2px; margin-left: 15px; margin-right: 5px;"></span>Declining\n                    </div>\n                </div>\n                \n                \x3c!-- Session Details --\x3e\n                <div style="display: flex; gap: 10px; flex-wrap: wrap;">\n        ',t.forEach((n,o)=>{const r=o>0&&(e.isMin?n.value>t[o-1].value:n.value<t[o-1].value),a=o>0&&(e.isMin?n.value<t[o-1].value:n.value>t[o-1].value),l=r?"‚¨ÜÔ∏è":a?"‚¨áÔ∏è":"",s=n.wasCoached?"#fff3cd":"#f8f9fa";i+=`\n                <div style="background: ${s}; padding: 8px 12px; border-radius: 4px; border: 1px solid #ddd;">\n                    <div style="font-size: 0.85em; color: #666;">${n.date}${n.dateRange?"<br>Week: "+n.dateRange:""}</div>\n                    <div style="font-size: 1.1em; font-weight: bold;">${l} ${n.value}${e.unit}</div>\n                    ${n.wasCoached?'<div style="font-size: 0.75em; color: #856404;">‚ö†Ô∏è Coached</div>':""}\n                </div>\n            `}),i+="\n                </div>\n            </div>\n        "}),i+='\n            <button onclick="showEmployeeDashboard()" style="background: #003DA5; color: white; border: none; border-radius: 4px; padding: 10px 20px; cursor: pointer; font-size: 1em; margin-top: 20px;">‚Üê Back to Dashboard</button>\n        </div>\n    ',document.getElementById("dashboardContent").innerHTML=i}function showEmployeeDashboard(){const e=getAllHistory(),t=document.getElementById("dashboardContent");if(0===Object.keys(e).length)t.innerHTML='<p class="empty-state">No employee data loaded yet.</p>';else{const n=Object.keys(e).sort(),i=new Set;Object.values(e).forEach(e=>{e.forEach(e=>{e.dateRange&&i.add(e.dateRange)})});const o=Array.from(i).sort().reverse();let r=`\n        \x3c!-- Employee and Date Range Selector --\x3e\n        <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">\n            <h3 style="color: #003DA5; margin-bottom: 15px;">üìä Track Coaching Effectiveness</h3>\n            <p style="color: #666; margin-bottom: 15px; font-size: 0.95em;">Select an employee to view their performance across different reporting periods and see if coaching helped improve their metrics.</p>\n            \n            <div style="margin-bottom: 15px;">\n                <label style="font-weight: bold; display: block; margin-bottom: 8px;">1Ô∏è‚É£ Select Employee:</label>\n                <select id="trendEmployeeSelect" onchange="updateDateRangeOptions()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em;">\n                    <option value="">-- Choose an employee --</option>\n                    ${n.map(e=>`<option value="${e}">${e}</option>`).join("")}\n                </select>\n            </div>\n            \n            <div id="dateRangeContainer" style="display: none; margin-bottom: 15px;">\n                <label style="font-weight: bold; display: block; margin-bottom: 8px;">2Ô∏è‚É£ Select Reporting Period:</label>\n                <select id="trendDateRangeSelect" onchange="showEmployeeTrendData()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em;">\n                    <option value="">-- Choose a date range --</option>\n                </select>\n            </div>\n            \n            <div id="trendDataDisplay" style="display: none; margin-top: 20px; padding: 15px; background: white; border-radius: 5px; border: 1px solid #ddd;">\n                \x3c!-- Trend data will be displayed here --\x3e\n            </div>\n        </div>\n\n        \x3c!-- Filter Section --\x3e\n        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">`;r+="<div>",r+='<label style="font-weight: bold; display: block; margin-bottom: 8px;">Filter by Employee:</label>',r+='<select id="employeeFilter" onchange="filterDashboard()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em;">',r+='<option value="">All Employees</option>',n.forEach(e=>{r+=`<option value="${e}">${e}</option>`}),r+="</select></div>",r+='<div id="dateFilterContainer" style="display: none;">',r+='<label style="font-weight: bold; display: block; margin-bottom: 8px;">Filter by Date:</label>',r+='<select id="dateFilter" onchange="filterDashboard()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em;">',r+='<option value="">All Dates</option>',o.forEach(e=>{r+=`<option value="${e}">${e}</option>`}),r+="</select></div>",r+="</div>";const a=Object.entries(e).sort((e,t)=>e[0].localeCompare(t[0]));r+='<div id="employeeList" style="display: flex; flex-direction: column; gap: 15px;">',a.forEach(([e,t])=>{const n=t.length,i=e.replace(/\s+/g,"-"),o=escapeHtml(e),a=e.replace(/\\/g,"\\\\").replace(/'/g,"\\'");r+=`\n                <div id="employee-card-${i}" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">\n                    <div style="background: #f8f9fa; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" \n                         onclick="document.getElementById('employee-${i}').style.display = document.getElementById('employee-${i}').style.display === 'none' ? 'block' : 'none'">\n                        <div>\n                            <strong style="font-size: 1.1em;">${o}</strong>\n                            <span style="margin-left: 10px; color: #666; font-size: 0.9em;">(${n} coaching session${n>1?"s":""})</span>\n                        </div>\n                        <div style="display: flex; gap: 10px; align-items: center;">\n                            <button onclick="event.stopPropagation(); diagnoseTrends('${a}')" \n                                    style="background: #28a745; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer; font-size: 0.9em;">üìä Diagnose Trends</button>\n                            <span style="font-size: 1.2em;">‚ñº</span>\n                        </div>\n                    </div>\n                    <div id="employee-${i}" style="display: none; padding: 15px; background: white;">\n            `,t.forEach((t,n)=>{const i=new Date(t.date).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),o=t.dateRange||"No week set",a=t.strugglingAreas.map(e=>AREA_NAMES[e]||e).join(", "),l=e.replace(/\\/g,"\\\\").replace(/'/g,"\\'"),s=escapeHtml(i),d=escapeHtml(o),c=escapeHtml(a);r+=`\n                    <div data-employee="${escapeHtml(e)}" data-date="${s}" data-week="${escapeHtml(t.dateRange||"")}" style="margin-bottom: 20px; padding: 10px; border-left: 3px solid #007bff; background: #f8f9fa; position: relative;">\n                        <button onclick="if(confirm('Delete this session?')) deleteSession('${l}', ${n})" \n                                style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 0.85em;">üóëÔ∏è Delete</button>\n                        <div style="font-weight: bold; margin-bottom: 5px;">Session ${n+1} - ${s}</div>\n                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">üìÖ Week: ${d}</div>\n                        <div style="color: #666; margin-bottom: 8px;"><strong>Areas:</strong> ${c}</div>\n                `,t.metrics&&(r+='<div style="font-size: 0.9em; color: #555; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 5px;">',t.metrics.scheduleAdherence&&(r+=`<div>Schedule: ${t.metrics.scheduleAdherence}%</div>`),t.metrics.fcr&&(r+=`<div>FCR: ${t.metrics.fcr}%</div>`),t.metrics.transfers&&(r+=`<div>Transfers: ${t.metrics.transfers}%</div>`),t.metrics.aht&&(r+=`<div>AHT: ${t.metrics.aht}s</div>`),t.metrics.acw&&(r+=`<div>ACW: ${t.metrics.acw}s</div>`),t.metrics.holdTime&&(r+=`<div>Hold: ${t.metrics.holdTime}s</div>`),t.metrics.reliability&&(r+=`<div>Reliability: ${t.metrics.reliability} hrs</div>`),t.metrics.overallSentiment&&(r+=`<div>Sentiment: ${t.metrics.overallSentiment}%</div>`),t.metrics.positiveWord&&(r+=`<div>Positive: ${t.metrics.positiveWord}%</div>`),t.metrics.negativeWord&&(r+=`<div>Negative: ${t.metrics.negativeWord}%</div>`),t.metrics.managingEmotions&&(r+=`<div>Emotions: ${t.metrics.managingEmotions}%</div>`),t.metrics.cxRepOverall&&(r+=`<div>CX Rep: ${t.metrics.cxRepOverall}%</div>`),r+="</div>"),r+="</div>"}),r+="\n                    </div>\n                </div>\n            "}),r+="</div>",t.innerHTML=r}showOnlySection("dashboardSection")}function updateDateRangeOptions(){const e=document.getElementById("trendEmployeeSelect")?.value||"",t=document.getElementById("trendDateRangeSelect"),n=document.getElementById("dateRangeContainer"),i=document.getElementById("trendDataDisplay");if(!t||!n)return;if(i&&(i.style.display="none"),!e)return n.style.display="none",void(t.innerHTML='<option value="">-- Choose a date range --</option>');const o=getAllHistory()[e]||[],r=[...new Set(o.map(e=>e.dateRange).filter(e=>e))];if(0===r.length)return n.style.display="none",void(t.innerHTML='<option value="">No date ranges available</option>');r.sort().reverse(),n.style.display="block",t.innerHTML='<option value="">-- Choose a date range --</option>'+r.map(e=>`<option value="${e}">${e}</option>`).join("")}function showEmployeeTrendData(){const e=document.getElementById("trendEmployeeSelect")?.value||"",t=document.getElementById("trendDateRangeSelect")?.value||"",n=document.getElementById("trendDataDisplay");if(!n||!e||!t)return void(n&&(n.style.display="none"));const i=getAllHistory()[e]||[],o=i.find(e=>e.dateRange===t);if(!o||!o.metrics)return n.innerHTML='<p style="color: #999; font-style: italic;">No data available for this date range.</p>',void(n.style.display="block");const r=o.metrics,a=new Date(o.date).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),l=o.strugglingAreas||[],s=l.length>0,d=i.sort((e,t)=>new Date(e.date)-new Date(t.date)),c=d.findIndex(e=>e.dateRange===t),m=c>0?d[c-1]:null;let p=`\n        <div style="border-bottom: 2px solid #003DA5; padding-bottom: 10px; margin-bottom: 15px;">\n            <h4 style="color: #003DA5; margin: 0;">${escapeHtml(e)} - ${escapeHtml(t)}</h4>\n            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">Uploaded: ${a}</div>\n            ${s?`<div style="margin-top: 8px; padding: 8px; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 3px;"><strong>‚ö†Ô∏è Coached on:</strong> ${l.map(e=>AREA_NAMES[e]||e).join(", ")}</div>`:'<div style="margin-top: 8px; color: #28a745; font-weight: bold;">‚úÖ Meeting all targets - No coaching needed</div>'}\n            ${m?`<div style="margin-top: 8px; padding: 8px; background: #e3f2fd; border-left: 3px solid #2196F3; border-radius: 3px; font-size: 0.9em;">üìà Comparing to previous period: ${m.dateRange}</div>`:""}\n        </div>\n        \n        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">\n    `;const u=[{key:"scheduleAdherence",label:"Schedule Adherence",unit:"%",target:TARGETS.driver.scheduleAdherence.min,isMin:!0},{key:"cxRepOverall",label:"CX Rep Overall",unit:"%",target:TARGETS.driver.cxRepOverall.min,isMin:!0},{key:"fcr",label:"First Call Resolution",unit:"%",target:TARGETS.driver.fcr.min,isMin:!0},{key:"overallExperience",label:"Overall Experience",unit:"%",target:TARGETS.driver.overallExperience.min,isMin:!0},{key:"transfers",label:"Transfers",unit:"%",target:TARGETS.driver.transfers.max,isMin:!1},{key:"overallSentiment",label:"Overall Sentiment",unit:"%",target:TARGETS.driver.overallSentiment.min,isMin:!0},{key:"positiveWord",label:"Positive Word",unit:"%",target:TARGETS.driver.positiveWord.min,isMin:!0},{key:"negativeWord",label:"Negative Word",unit:"%",target:TARGETS.driver.negativeWord.min,isMin:!0},{key:"managingEmotions",label:"Managing Emotions",unit:"%",target:TARGETS.driver.managingEmotions.min,isMin:!0},{key:"aht",label:"AHT",unit:"s",target:TARGETS.driver.aht.max,isMin:!1},{key:"acw",label:"ACW",unit:"s",target:TARGETS.driver.acw.max,isMin:!1},{key:"holdTime",label:"Hold Time",unit:"s",target:TARGETS.driver.holdTime.max,isMin:!1},{key:"reliability",label:"Reliability",unit:" hrs",target:TARGETS.driver.reliability.max,isMin:!1}];if(u.forEach(e=>{const t=r[e.key];if(("fcr"!==e.key&&"cxRepOverall"!==e.key&&"overallExperience"!==e.key||""!==t&&null!=t)&&void 0!==t&&""!==t&&null!==t){const n=e.isMin?t>=e.target:t<=e.target,i=n?"‚úÖ":"‚ö†Ô∏è",o=n?"#28a745":"#dc3545",r=l.includes(e.key);let a="";if(m&&m.metrics&&m.metrics[e.key]){const n=t-m.metrics[e.key],i=(m.strugglingAreas||[]).includes(e.key);if(0!==n){const t=e.isMin?n>0:n<0,o=t?"üìà":"üìâ",r=t?"#28a745":"#dc3545",l=Math.abs(n).toFixed(2);a=`<div style="font-size: 0.75em; margin-top: 5px; color: ${r}; font-weight: bold;">${o} ${t?"+":""}${n>0?"+":""}${l}${e.unit} from last period</div>`,i&&t&&(a=`<div style="font-size: 0.75em; margin-top: 5px; padding: 4px; background: #d4edda; border-radius: 3px; color: #155724; font-weight: bold;">üéØ Coaching worked! +${l}${e.unit}</div>`)}}p+=`\n                <div style="padding: 12px; background: ${r?"#fff3cd":"#f8f9fa"}; border-radius: 5px; border: 1px solid #ddd;">\n                    <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">${e.label}</div>\n                    <div style="font-size: 1.4em; font-weight: bold; color: ${o};">${i} ${t}${e.unit}</div>\n                    <div style="font-size: 0.8em; color: #666; margin-top: 3px;">Target: ${e.isMin?"‚â•":"‚â§"}${e.target}${e.unit}</div>\n                    ${r?'<div style="font-size: 0.75em; color: #856404; margin-top: 3px; font-weight: bold;">üìã Coached this period</div>':""}\n                    ${a}\n                </div>\n            `}}),p+="</div>",m){const e=m.strugglingAreas||[],t=[],n=[];e.forEach(e=>{const i=r[e],o=m.metrics?m.metrics[e]:null;if(void 0!==i&&void 0!==o&&""!==i&&""!==o){const r=u.find(t=>t.key===e);if(r){const a=i-o;(r.isMin?a>0:a<0)?t.push(AREA_NAMES[e]||e):(a<0&&r.isMin||a>0&&!r.isMin)&&n.push(AREA_NAMES[e]||e)}}}),(t.length>0||n.length>0)&&(p+='\n                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #ddd;">\n                    <h4 style="color: #003DA5; margin: 0 0 10px 0;">üìä Coaching Impact Summary</h4>\n            ',t.length>0&&(p+=`<div style="margin-bottom: 8px; padding: 8px; background: #d4edda; border-left: 3px solid #28a745; border-radius: 3px;">\n                    <strong style="color: #155724;">‚úÖ Improved After Coaching (${t.length}):</strong> ${t.join(", ")}\n                </div>`),n.length>0&&(p+=`<div style="padding: 8px; background: #f8d7da; border-left: 3px solid #dc3545; border-radius: 3px;">\n                    <strong style="color: #721c24;">‚ö†Ô∏è Still Needs Work (${n.length}):</strong> ${n.join(", ")}\n                </div>`),p+="</div>")}n.innerHTML=p,n.style.display="block"}function filterDashboard(){const e=document.getElementById("employeeFilter")?.value||"",t=document.getElementById("dateFilter")?.value||"",n=document.getElementById("dateFilterContainer");if(n)if(e)n.style.display="block";else{n.style.display="none";const e=document.getElementById("dateFilter");e&&(e.value="")}const i=getAllHistory();Object.keys(i).forEach(n=>{const i=n.replace(/\s+/g,"-"),o=document.getElementById(`employee-card-${i}`),r=document.getElementById(`employee-${i}`);if(!o||!r)return;const a=!e||n===e,l=r.querySelectorAll("[data-employee]");let s=0;l.forEach(n=>{const i=n.getAttribute("data-employee"),o=n.getAttribute("data-week");(!e||i===e)&&(!t||o===t)?(n.style.display="block",s++):n.style.display="none"}),o.style.display=a&&0!==s?"block":"none"})}function initApp(){function e(){const e=getAllHistory(),t=new Set;Object.values(e).forEach(e=>{e.forEach(e=>{e.dateRange&&t.add(e.dateRange)})});const n=document.getElementById("quickAccessContainer"),i=document.getElementById("dividerContainer"),o=document.getElementById("quickDateRange");t.size>0&&(n.style.display="block",i.style.display="block",Array.from(t).sort().reverse().forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,o.appendChild(t)}))}console.log("üöÄ Coaching Tool Initialized"),(async()=>{try{serverTips=await loadServerTips(),userTips=loadUserTips(),hiddenTips=loadHiddenTips(),tipOrder=loadTipOrder(),uploadHistory=loadUploadHistory(),mergeTips(),console.log("‚úÖ Tips loaded successfully")}catch(e){console.warn("‚ö†Ô∏è Using fallback tips:",e)}})(),window.updateQuickAccessEmployees=function(){const e=document.getElementById("quickDateRange")?.value||"",t=document.getElementById("quickEmployee");if(!t)return;if(t.innerHTML='<option value="">-- Choose employee --</option>',!e)return;const n=getAllHistory(),i=new Set;Object.entries(n).forEach(([t,n])=>{Array.isArray(n)&&n.some(t=>t.dateRange===e)&&i.add(t)}),Array.from(i).sort().forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)})},document.getElementById("quickAccessLoadBtn")?.addEventListener("click",()=>{const e=document.getElementById("quickDateRange")?.value||"",t=document.getElementById("quickEmployee")?.value||"";if(!e||!t)return void alert("Please select both a date range and employee");const n=getAllHistory()[t]||[];if(!Array.isArray(n)||0===n.length)return void alert("No sessions found for this employee.");const i=n.find(t=>t&&t.dateRange===e);if(!i||!i.metrics||"object"!=typeof i.metrics)return void alert("No data found for this employee and date range.");const o=i.metrics,r=escapeHtml(t);document.getElementById("employeeName").value=r;m(o,"number"==typeof o.surveyTotal?o.surveyTotal:0);const a=e.split(" to ");2===a.length&&a[0]&&a[1]?(document.getElementById("startDate").value=a[0].trim(),document.getElementById("endDate").value=a[1].trim()):console.warn("Invalid date range format:",e),document.getElementById("employeeInfoSection").style.display="block",document.getElementById("metricsSection").style.display="block",p(t,o),document.getElementById("employeeName").scrollIntoView({behavior:"smooth",block:"center"})}),document.getElementById("homeBtn")?.addEventListener("click",()=>{showOnlySection("coachingForm"),document.getElementById("coachingForm")?.scrollIntoView({behavior:"smooth",block:"start"})});const t=document.getElementById("employeeDashboard");console.log("Dashboard button found:",t),t&&t.addEventListener("click",e=>{console.log("Dashboard button clicked"),e.preventDefault(),showEmployeeDashboard()});const n=document.getElementById("manageTips");console.log("Tips button found:",n),n&&n.addEventListener("click",e=>{console.log("Tips button clicked"),e.preventDefault(),showTipsManagement()}),document.getElementById("closeTipsManagement")?.addEventListener("click",()=>{showOnlySection("coachingForm")}),document.getElementById("executiveSummaryBtn")?.addEventListener("click",()=>{const e=generateExecutiveSummaryPrompt();document.getElementById("execSummaryPrompt").value=e,showOnlySection("executiveSummarySection")}),document.getElementById("copyExecSummary")?.addEventListener("click",()=>{const e=document.getElementById("execSummaryPrompt").value;navigator.clipboard.writeText(e).then(()=>{navigator.onLine?(showToast("‚úÖ Summary copied! Opening Copilot..."),window.open("https://copilot.microsoft.com/","_blank")):showToast("‚úÖ Summary copied! Paste in Copilot.")}).catch(()=>{alert("Failed to copy. Please select the text and copy manually.")})}),document.getElementById("outlookExecSummary")?.addEventListener("click",()=>{const e=document.getElementById("generatedExecSummary")?.value.trim();if(!e)return void alert("Please paste the generated summary from Copilot first!");const t=`mailto:?subject=${encodeURIComponent("Team Performance Summary - Development Coaching Tool")}&body=${encodeURIComponent(e)}`;window.location.href=t}),document.getElementById("closeExecSummary")?.addEventListener("click",()=>{showOnlySection("coachingForm")}),document.getElementById("backToFormBtn")?.addEventListener("click",()=>{showOnlySection("coachingForm"),document.getElementById("coachingForm")?.scrollIntoView({behavior:"smooth",block:"start"})}),document.getElementById("metricSelect")?.addEventListener("change",e=>{showMetricTips(e.target.value)}),document.getElementById("exportTips")?.addEventListener("click",()=>{const e={exportDate:(new Date).toISOString(),version:"1.0",customTips:userTips},t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=`coaching-tips-${(new Date).toISOString().split("T")[0]}.json`,o.click(),URL.revokeObjectURL(i),alert("‚úÖ Tips exported successfully!")}),document.getElementById("importTips")?.addEventListener("click",()=>{document.getElementById("tipsFileInput").click()}),document.getElementById("exportDataBtn")?.addEventListener("click",function(){try{const e={version:1,exportedAt:(new Date).toISOString(),coachingHistory:JSON.parse(localStorage.getItem("coachingHistory")||"{}"),userCustomTips:loadUserTips()},t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=`coaching-backup-${(new Date).toISOString().split("T")[0]}.json`,o.click(),URL.revokeObjectURL(i),alert("‚úÖ Backup created. Save the JSON file safely.")}catch(e){console.error("Backup failed",e),alert("‚ùå Backup failed. See console for details.")}}),document.getElementById("importDataBtn")?.addEventListener("click",()=>{document.getElementById("dataFileInput")?.click()}),document.getElementById("dataFileInput")?.addEventListener("change",t=>{const n=t.target.files[0];n&&function(t){const n=new FileReader;n.onload=t=>{try{const n=JSON.parse(t.target.result);if(!n||"object"!=typeof n)return void alert("‚ùå Invalid backup file.");const i=n.coachingHistory||{},o=n.userCustomTips||{},r=confirm("Merge with existing data?\nOK = Merge, Cancel = Replace.");let a={};if(r){const e=getAllHistory();a={...e},Object.entries(i).forEach(([e,t])=>{if(!Array.isArray(t))return;const n=[...a[e]||[]];t.forEach(e=>{const t=`${e.dateRange||""}|${e.date||""}`;n.some(e=>`${e.dateRange||""}|${e.date||""}`===t)||n.push(e)}),a[e]=n})}else a=i;localStorage.setItem("coachingHistory",JSON.stringify(a)),userTips=o||{},saveUserTips(userTips),mergeTips(),e(),alert("‚úÖ Data restored successfully.")}catch(e){console.error("Import failed",e),alert("‚ùå Could not import backup. Make sure it is a valid JSON export.")}},n.readAsText(t)}(n),t.target.value=""}),document.getElementById("tipsFileInput")?.addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=e=>{try{const t=JSON.parse(e.target.result);if(!t||"object"!=typeof t||!t.customTips)return void alert("‚ùå Invalid tips file format. Expected JSON with customTips property.");confirm("Do you want to MERGE these tips with your existing tips?\n\nClick OK to merge (keeps your current tips + adds new ones)\nClick Cancel to REPLACE all your tips with imported ones")?Object.keys(t.customTips).forEach(e=>{userTips[e]||(userTips[e]=[]);const n=t.customTips[e];Array.isArray(n)&&n.forEach(t=>{t&&!userTips[e].includes(t)&&userTips[e].push(t)})}):(userTips={},Object.keys(t.customTips).forEach(e=>{const n=t.customTips[e];Array.isArray(n)&&(userTips[e]=n.filter(e=>e&&"string"==typeof e))})),saveUserTips(userTips),mergeTips();const n=document.getElementById("metricSelect").value;n&&showMetricTips(n),alert("‚úÖ Tips imported successfully!")}catch(e){alert("‚ùå Error reading tips file. Please make sure it's a valid JSON file."),console.error(e)}},n.readAsText(t),e.target.value=""}),document.getElementById("closeHistory")?.addEventListener("click",()=>{showOnlySection("coachingForm")}),document.getElementById("closeDashboard")?.addEventListener("click",()=>{showOnlySection("coachingForm")}),document.getElementById("backToForm")?.addEventListener("click",()=>{showOnlySection("coachingForm")}),document.getElementById("clearHistoryBtn")?.addEventListener("click",()=>{confirm("Are you sure you want to clear all email history? This cannot be undone.")&&clearAllHistory()}),document.getElementById("clearDashboardHistoryBtn")?.addEventListener("click",()=>{confirm("Are you sure you want to clear all email history? This cannot be undone.")&&clearAllHistory()});let i=[];function o(e=""){const t=document.getElementById("employeeSelect");if(!t)return;const n=e.trim().toLowerCase();t.innerHTML='<option value="">-- Choose an employee --</option>',i.forEach((e,i)=>{if(!n||e.name.toLowerCase().includes(n)){const n=document.createElement("option");n.value=i,n.textContent=e.name,t.appendChild(n)}})}function r(){const e=document.getElementById("startDate")?.value||"",t=document.getElementById("endDate")?.value||"",n=document.getElementById("loadDataBtn"),i=document.getElementById("dateValidationMsg"),o=document.getElementById("excelFile");if(!n)return;const r=o?.files&&o.files.length>0;n.disabled=!0,n.style.background="#ccc",n.style.opacity="0.5",n.style.cursor="not-allowed",r?e&&t?new Date(t)<new Date(e)?i&&(i.textContent="‚ö†Ô∏è End date must be after or equal to start date",i.style.display="block"):(n.disabled=!1,n.style.background="linear-gradient(135deg, #2196F3 0%, #1976D2 100%)",n.style.opacity="1",n.style.cursor="pointer",i&&(i.textContent="‚úÖ Ready to load data",i.style.color="#28a745",i.style.display="block")):i&&(i.textContent="‚ö†Ô∏è Please enter both Start and End dates to load data",i.style.display="block"):i&&(i.textContent="‚ö†Ô∏è Please select a file first",i.style.display="block")}function a(e){if(!e&&0!==e)return 0;if("N/A"===e||"n/a"===e)return 0;if("number"==typeof e&&e<=1)return parseFloat((100*e).toFixed(2));if("string"==typeof e&&e.includes("%")){const t=parseFloat(e.replace("%",""));return isNaN(t)?0:t}const t=parseFloat(e);return isNaN(t)?0:t}function l(e){if(!e&&0!==e)return"";if("N/A"===e||"n/a"===e)return"";if("number"==typeof e&&e<=1)return parseFloat((100*e).toFixed(2));if("string"==typeof e&&e.includes("%")){const t=parseFloat(e.replace("%",""));return isNaN(t)?"":t}const t=parseFloat(e);return isNaN(t)?"":t}function s(e){if(!e&&0!==e)return"";const t=parseFloat(e);return isNaN(t)?"":Math.round(t)}function d(e){if(!e&&0!==e)return 0;const t=parseFloat(e);return isNaN(t)?0:parseFloat(t.toFixed(2))}function c(){[{id:"scheduleAdherence",target:TARGETS.driver.scheduleAdherence.min,type:"min"},{id:"cxRepOverall",target:TARGETS.driver.cxRepOverall.min,type:"min"},{id:"fcr",target:TARGETS.driver.fcr.min,type:"min"},{id:"overallExperience",target:TARGETS.driver.overallExperience.min,type:"min"},{id:"transfers",target:TARGETS.driver.transfers.max,type:"max"},{id:"overallSentiment",target:TARGETS.driver.overallSentiment.min,type:"min"},{id:"positiveWord",target:TARGETS.driver.positiveWord.min,type:"min"},{id:"negativeWord",target:TARGETS.driver.negativeWord.min,type:"min"},{id:"managingEmotions",target:TARGETS.driver.managingEmotions.min,type:"min"},{id:"aht",target:TARGETS.driver.aht.max,type:"max"},{id:"acw",target:TARGETS.driver.acw.max,type:"max"},{id:"holdTime",target:TARGETS.driver.holdTime.max,type:"max"},{id:"reliability",target:TARGETS.driver.reliability.max,type:"max"}].forEach(e=>{const t=document.getElementById(e.id);if(!t)return;const n=parseFloat(t.value);if(isNaN(n))return t.style.background="",void(t.style.borderColor="");const i="min"===e.type?n>=e.target:n<=e.target;t.style.background=i?"#d4edda":"#fff3cd",t.style.borderColor=i?"#28a745":"#ffc107"})}function m(e={},t=0){const n=Number(t)>0,i=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t)};i("surveyTotal",n?t:""),i("scheduleAdherence",e.scheduleAdherence??""),i("cxRepOverall",n?e.cxRepOverall??"":""),i("fcr",n?e.fcr??"":""),i("overallExperience",n?e.overallExperience??"":""),i("transfers",e.transfers??""),i("aht",e.aht??""),i("acw",e.acw??""),i("holdTime",e.holdTime??""),i("reliability",e.reliability??""),i("overallSentiment",e.overallSentiment??""),i("positiveWord",e.positiveWord??""),i("negativeWord",e.negativeWord??""),i("managingEmotions",e.managingEmotions??""),c()}function p(e,t){const n=document.getElementById("ytdComparison");if(!n)return;const i=getAllHistory()[e]||[];if(0===i.length)return void(n.style.display="none");const o={},r={};i.forEach(e=>{e.metrics&&Object.keys(e.metrics).forEach(t=>{const n=e.metrics[t];""!==n&&null!=n&&(o[t]||(o[t]=0,r[t]=0),o[t]+=parseFloat(n),r[t]++)})});const a={};Object.keys(o).forEach(e=>{a[e]=o[e]/r[e]});const l=[];if([{key:"scheduleAdherence",name:"Schedule Adherence",unit:"%",isMin:!0},{key:"transfers",name:"Transfers",unit:"%",isMin:!1},{key:"overallSentiment",name:"Overall Sentiment",unit:"%",isMin:!0},{key:"aht",name:"AHT",unit:"s",isMin:!1},{key:"acw",name:"ACW",unit:"s",isMin:!1}].forEach(e=>{const n=t[e.key],i=a[e.key];if(void 0!==n&&""!==n&&void 0!==i){const t=n-i,o=e.isMin?t>0:t<0;Math.abs(t)>.01&&l.push({name:e.name,current:n,ytd:i.toFixed(2),diff:t.toFixed(2),unit:e.unit,isBetter:o})}}),0===l.length)return void(n.style.display="none");let s=`\n            <strong style="color: #003DA5;">üìä YTD Performance vs This Report (${i.length} period${i.length>1?"s":""} tracked):</strong>\n            <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;">\n        `;l.forEach(e=>{const t=e.isBetter?"‚¨ÜÔ∏è":"‚¨áÔ∏è",n=e.isBetter?"#28a745":"#dc3545",i=e.diff>0?"+":"";s+=`\n                <span style="display: inline-block; padding: 5px 10px; background: white; border-radius: 4px; border: 1px solid ${n}; font-size: 0.85em;">\n                    <strong style="color: ${n};">${t} ${e.name}:</strong> \n                    ${e.current}${e.unit} \n                    <span style="color: #666;">(YTD avg: ${e.ytd}${e.unit}, ${i}${e.diff}${e.unit})</span>\n                </span>\n            `}),s+="</div>",n.innerHTML=s,n.style.display="block"}document.getElementById("startDate")?.addEventListener("click",function(){this.showPicker()}),document.getElementById("endDate")?.addEventListener("click",function(){this.showPicker()}),document.getElementById("startDate")?.addEventListener("change",r),document.getElementById("startDate")?.addEventListener("input",r),document.getElementById("endDate")?.addEventListener("change",r),document.getElementById("endDate")?.addEventListener("input",r),document.getElementById("excelFile")?.addEventListener("change",e=>{if(e.target.files.length>0){const e=document.getElementById("dateRangeInputContainer");e&&(e.style.display="block"),r()}else{const e=document.getElementById("dateRangeInputContainer");e&&(e.style.display="none"),r()}}),document.getElementById("employeeSearch")?.addEventListener("input",e=>{o(e.target.value||"")}),document.getElementById("consolidatedMetricsBtn")?.addEventListener("click",()=>{const e=document.getElementById("employeeName")?.value||"";if(!e)return void alert("Please select or enter an employee first.");const t=parseInt(document.getElementById("surveyTotal").value,10)||0,n=t>0,i=document.getElementById("surveyTotal");i&&(i.value=n?t:0);const o=document.getElementById("surveyStatusMsg");o&&(o.textContent=n?"":"No surveys in this date range; survey-based metrics are omitted.");const r={scheduleAdherence:parseFloat(document.getElementById("scheduleAdherence").value)||0,cxRepOverall:n&&document.getElementById("cxRepOverall").value.trim()?parseFloat(document.getElementById("cxRepOverall").value):"",fcr:n&&document.getElementById("fcr").value.trim()?parseFloat(document.getElementById("fcr").value):"",overallExperience:n&&document.getElementById("overallExperience").value.trim()?parseFloat(document.getElementById("overallExperience").value):"",transfers:parseFloat(document.getElementById("transfers").value)||0,overallSentiment:parseFloat(document.getElementById("overallSentiment").value)||0,positiveWord:parseFloat(document.getElementById("positiveWord").value)||0,negativeWord:parseFloat(document.getElementById("negativeWord").value)||0,managingEmotions:parseFloat(document.getElementById("managingEmotions").value)||0,aht:parseFloat(document.getElementById("aht").value)||0,acw:parseFloat(document.getElementById("acw").value)||0,holdTime:parseFloat(document.getElementById("holdTime").value)||0,reliability:parseFloat(document.getElementById("reliability").value)||0},a=document.getElementById("consolidatedMetrics"),l=document.getElementById("consolidatedMetricsStatus");if(!a||!l)return;l.textContent="Calculating...";const s=buildConsolidatedMetrics(e,r);a.innerHTML=s,a.style.display="block",l.textContent="Showing current metrics vs targets (with previous/YTD deltas when available)."}),setTimeout(()=>{try{r()}catch(e){console.warn("Error validating date range during init:",e)}},150),setTimeout(()=>{try{e()}catch(e){console.warn("Error initializing quick access:",e)}},200),document.getElementById("loadDataBtn")?.addEventListener("click",()=>{const e=document.getElementById("excelFile").files[0],t=document.getElementById("startDate")?.value||"",n=document.getElementById("endDate")?.value||"";if(!e)return void alert("‚ùå Please select an Excel file first");if(!t||!n)return alert("‚ùå Both Start and End dates are REQUIRED.\n\nPlease select the date range for this data before loading."),void document.getElementById("startDate")?.focus();if(new Date(n)<new Date(t))return alert("‚ùå End date must be after or equal to start date."),void document.getElementById("endDate")?.focus();const r=new FileReader;r.onload=e=>{try{const t=new Uint8Array(e.target.result),n=XLSX.read(t,{type:"array"}),r=n.Sheets[n.SheetNames[0]],c=XLSX.utils.sheet_to_json(r,{range:0,defval:""});i=c.map(e=>{const t=e["Name (Last, First)"]||"",n={name:t.includes(",")?t.split(",")[1].trim():t,scheduleAdherence:a(e["Adherence%"]),cxRepOverall:l(e["RepSat%"]),fcr:l(e["FCR%"]),overallExperience:l(e["OverallExperience%"]||e["Overall Experience%"]||e["OE%"]),transfers:a(e["TransfersS%"]||e["TransferS%"]||e["Transfers%"]),aht:s(e.AHT),acw:s(e.ACW),holdTime:s(e.Hold),reliability:d(e["Reliability Hrs"]),overallSentiment:a(e["OverallSentimentScore%"]),positiveWord:a(e["PositiveWordScore%"]),negativeWord:a(e["AvoidNegativeWordScore%"]),managingEmotions:a(e["ManageEmotionsScore%"]),surveyTotal:parseInt(e["OE Survey Total"])||0};return n.surveyTotal&&0!==n.surveyTotal||(n.cxRepOverall="",n.fcr="",n.overallExperience=""),n}).filter(e=>e.name);o(document.getElementById("employeeSearch")?.value||""),document.getElementById("employeeSelectContainer").style.display="block",document.getElementById("dateRangeInputContainer").style.display="block",function(){try{if(!i||0===i.length)return void console.log("No employee data to save");const e=document.getElementById("startDate")?.value||"",t=document.getElementById("endDate")?.value||"",n=e&&t?`${e} to ${t}`:"";if(!n)return void console.warn("No date range available for saving");let o=0,r=0;i.forEach(e=>{const t=e.name||"";if(!t)return void console.log("Skipping employee with no name");if((getEmployeeHistory(t)||[]).some(e=>(e.dateRange||"")===n))return console.log(`Skipping ${t} - already has data for ${n}`),void r++;const i={scheduleAdherence:e.scheduleAdherence,cxRepOverall:e.cxRepOverall??"",fcr:e.fcr??"",overallExperience:e.overallExperience??"",transfers:e.transfers,overallSentiment:e.overallSentiment,positiveWord:e.positiveWord,negativeWord:e.negativeWord,managingEmotions:e.managingEmotions,aht:e.aht,acw:e.acw,holdTime:e.holdTime,reliability:e.reliability,surveyTotal:e.surveyTotal??0};saveToHistory(t,identifyStrugglingAreas(i),i,n),o++,console.log(`Saved ${t} for ${n}`)}),console.log(`Bulk save complete: ${o} saved, ${r} skipped (duplicates)`)}catch(e){console.error("Bulk save failed:",e)}}();const m=document.getElementById("startDate")?.value||"",p=document.getElementById("endDate")?.value||"",u=m&&p?detectTimePeriod(m,p):"Custom Upload",g={id:Date.now(),timePeriod:u,startDate:m,endDate:p,employeeCount:i.length,timestamp:(new Date).toISOString(),employeeMetrics:i};uploadHistory.push(g),saveUploadHistory(uploadHistory),alert(`‚úÖ Successfully loaded ${i.length} employees!\n\nüìä Data saved to Employee History.\n\n‚è∞ Recorded as: ${u}\n\nYou can now select an employee from the dropdown to coach them, or view trends in Employee History.`)}catch(e){console.error("Error parsing Excel:",e),alert("Error reading Excel file. Please make sure it is formatted correctly.")}},r.readAsArrayBuffer(e)}),document.getElementById("employeeSelect")?.addEventListener("change",e=>{const t=e.target.value,n=document.getElementById("pastDateRangesContainer"),o=document.getElementById("pastDateRanges");if(o&&(o.innerHTML='<option value="">-- Select a past date range --</option>'),n&&(n.style.display="none"),""===t||!i||0===i.length){const e=document.getElementById("metricsSection"),t=document.getElementById("employeeInfoSection");return e&&(e.style.display="none"),void(t&&(t.style.display="none"))}const a=i[t];if(!a)return void alert("Error: Employee data not found.");const l=document.getElementById("employeeInfoSection"),s=document.getElementById("metricsSection");l&&(l.style.display="block"),s&&(s.style.display="block"),document.getElementById("employeeName").value=a.name||"",m(a,a.surveyTotal??0),p(a.name,a);try{const e=getEmployeeHistory(a.name)||[],t=Array.from(new Set(e.map(e=>e.dateRange).filter(e=>e&&"string"==typeof e&&e.includes(" to "))));if(t.length>0){t.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,o.appendChild(t)}),n.style.display="block";const i=e[e.length-1]?.dateRange;if(i&&i.includes(" to ")){o.value=i;const e=i.split(" to ");if(2===e.length){document.getElementById("startDate").value=e[0],document.getElementById("endDate").value=e[1];try{r()}catch{}}}}}catch(e){console.warn("Could not populate past ranges:",e)}document.getElementById("generatedEmail").value="",document.getElementById("employeeName").scrollIntoView({behavior:"smooth",block:"center"})}),document.getElementById("pastDateRanges")?.addEventListener("change",e=>{const t=e.target.value;if(!t)return;const n=t.split(" to ");if(2===n.length){const[e,t]=n,i=document.getElementById("startDate"),o=document.getElementById("endDate");if(i&&o){i.value=e,o.value=t;const n=document.getElementById("dateRangeInputContainer");n&&(n.style.display="block");try{r()}catch{}}}}),["scheduleAdherence","cxRepOverall","fcr","overallExperience","transfers","aht","acw","holdTime","reliability","overallSentiment","positiveWord","negativeWord","managingEmotions"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("input",c)}),document.getElementById("generatedEmail")?.addEventListener("input",e=>{const t=e.target.value.trim(),n=document.getElementById("resultName").textContent;t&&n&&(window.currentEmailData={name:n,content:t})}),document.getElementById("outlookEmail")?.addEventListener("click",()=>{const e=document.getElementById("generatedEmail")?.value.trim(),t=document.getElementById("resultName").textContent;if(!e)return void alert("Please paste the generated email from Copilot first!");if(!t)return void alert("Employee name not found!");const n=generateEmailContent(t,e),i=encodeURIComponent(n.subject),o=encodeURIComponent(n.body),r=`mailto:${n.to}?subject=${i}&body=${o}`;window.location.href=r}),document.getElementById("copyPrompt")?.addEventListener("click",()=>{const e=document.getElementById("aiPrompt").value;navigator.clipboard.writeText(e).then(()=>{navigator.onLine?(alert("‚úÖ Prompt copied!\n\nOpening Copilot - paste it there."),window.open("https://copilot.microsoft.com/","_blank")):alert("‚úÖ Prompt copied!\n\nOffline mode: Copilot won't open. Paste the prompt wherever you prefer.")}).catch(()=>{alert("Failed to copy. Please select the text and copy manually.")})}),document.getElementById("exportPdfBtn")?.addEventListener("click",()=>{exportToPDF()}),document.getElementById("newCoaching")?.addEventListener("click",()=>{showOnlySection("coachingForm"),document.getElementById("generatedEmail").value="",document.getElementById("coachingForm").reset()}),document.getElementById("coachingForm")?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("employeeName").value;if(!t)return void alert("Please fill in employee name");const n=parseInt(document.getElementById("surveyTotal").value,10)||0,i=n>0,o={scheduleAdherence:parseFloat(document.getElementById("scheduleAdherence").value)||0,cxRepOverall:i&&document.getElementById("cxRepOverall").value.trim()?parseFloat(document.getElementById("cxRepOverall").value):"",fcr:i&&document.getElementById("fcr").value.trim()?parseFloat(document.getElementById("fcr").value):"",overallExperience:i&&document.getElementById("overallExperience").value.trim()?parseFloat(document.getElementById("overallExperience").value):"",transfers:parseFloat(document.getElementById("transfers").value)||0,overallSentiment:parseFloat(document.getElementById("overallSentiment").value)||0,positiveWord:parseFloat(document.getElementById("positiveWord").value)||0,negativeWord:parseFloat(document.getElementById("negativeWord").value)||0,managingEmotions:parseFloat(document.getElementById("managingEmotions").value)||0,aht:parseFloat(document.getElementById("aht").value)||0,acw:parseFloat(document.getElementById("acw").value)||0,holdTime:parseFloat(document.getElementById("holdTime").value)||0,reliability:parseFloat(document.getElementById("reliability").value)||0,surveyTotal:n},r=identifyStrugglingAreas(o),a=getEmployeeHistory(t),l=a.length>0,s={};a.forEach(e=>{e.strugglingAreas&&e.strugglingAreas.forEach(e=>{s[e]=(s[e]||0)+1})});const d=[];o.scheduleAdherence>=TARGETS.driver.scheduleAdherence.min&&d.push(`Schedule Adherence: ${o.scheduleAdherence}% (Target: ${TARGETS.driver.scheduleAdherence.min}%)`),o.cxRepOverall&&o.cxRepOverall>=TARGETS.driver.cxRepOverall.min&&d.push(`Customer Experience: ${o.cxRepOverall}% (Target: ${TARGETS.driver.cxRepOverall.min}%)`),o.fcr&&o.fcr>=TARGETS.driver.fcr.min&&d.push(`FCR: ${o.fcr}% (Target: ${TARGETS.driver.fcr.min}%)`),o.overallExperience&&o.overallExperience>=TARGETS.driver.overallExperience.min&&d.push(`Overall Experience: ${o.overallExperience}% (Target: ${TARGETS.driver.overallExperience.min}%)`),o.overallSentiment>=TARGETS.driver.overallSentiment.min&&d.push(`Overall Sentiment: ${o.overallSentiment}% (Target: ${TARGETS.driver.overallSentiment.min}%)`),o.managingEmotions>=TARGETS.driver.managingEmotions.min&&d.push(`Managing Emotions: ${o.managingEmotions}% (Target: ${TARGETS.driver.managingEmotions.min}%)`),o.transfers<=TARGETS.driver.transfers.max&&d.push(`Transfers: ${o.transfers}% (Target: <${TARGETS.driver.transfers.max}%)`),o.aht<=TARGETS.driver.aht.max&&d.push(`AHT: ${o.aht} seconds (Target: <${TARGETS.driver.aht.max} seconds)`);const c=[`Hey ${t}! Quick snapshot on how things are trending so we can celebrate wins and line up next steps.`,`Hey ${t}! Here's a quick look at your recent performance so we can keep what works and tune the rest.`,`Hey ${t}! Fast pulse check on your latest metrics so we can celebrate and sharpen where needed.`,`Hey ${t}! Quick rundown of what's landing well and what we should focus on next.`,`Hey ${t}! Short update on your recent results to highlight wins and pick a couple priorities.`,`Hey ${t}! Quick vibe check on your recent results so we can keep momentum and tighten a couple areas.`,`Hey ${t}! Quick look at what is working and what to fine-tune this week.`,`Hey ${t}! Quick pulse on your week so we can high-five the wins and pick two focus points.`],m=[["I noticed","By the way","Quick thing","Real talk"],["Heads up","Quick heads up","I spotted","Worth noting"],["I saw","Side note","One callout","Real quick"],["Noticed this","Flagging this","Quick flag","One thing I liked"]],p=[["Here is the thing","Also","One more thing","Meanwhile"],["So","Plus","And hey","Another quick one"],["Also worth noting","On that note","Real quick","Next up"],["Here is what I saw","Also saw","And","Last quick note"]],u=["Sound like a human coworker. Use contractions, vary sentence length, mix short and medium lines. No em dashes; use commas, periods, or regular hyphens instead.","Keep it breezy and specific. Contractions are good, sentences can start with And/But. Avoid em dashes; stick to commas, periods, or regular hyphens.","Use casual, direct language with contractions. Vary rhythm with short and medium sentences. Skip em dashes; use commas, periods, or regular hyphens.","Friendly, clear, and concise. Contractions welcome. Mix sentence lengths. Avoid em dashes; choose commas, periods, or regular hyphens."],g=c[Math.floor(Math.random()*c.length)],y=m[Math.floor(Math.random()*m.length)],v=p[Math.floor(Math.random()*p.length)];let h=`Write a friendly coaching email to ${t} (CSR), 180‚Äì220 words. ${u[Math.floor(Math.random()*u.length)]} Include a couple casual phrases (e.g., ${y.join(", ")}), and vary transitions (e.g., ${v.join(", ")}). Be specific without sounding robotic. Start with this opener: "${g}". Briefly set context, then list wins and improvements.\n\n`;if(i||(h+="Note: No customer surveys in the selected date range, so survey-based metrics (CX Rep Overall, FCR, Overall Experience) are omitted.\n\n"),d.length>0&&(h+=`WINS: ${d.join(", ")}\n\n`),0===r.length)h+="All targets met! Congratulate them.";else{const e=[];r.forEach(t=>{const n=AREA_NAMES[t]||t;let i,r,a="%";"scheduleAdherence"===t?(i=o.scheduleAdherence,r=TARGETS.driver.scheduleAdherence.min):"cxRepOverall"===t?(i=o.cxRepOverall,r=TARGETS.driver.cxRepOverall.min):"fcr"===t?(i=o.fcr,r=TARGETS.driver.fcr.min):"transfers"===t?(i=o.transfers,r=TARGETS.driver.transfers.max):"overallSentiment"===t?(i=o.overallSentiment,r=TARGETS.driver.overallSentiment.min):"positiveWord"===t?(i=o.positiveWord,r=TARGETS.driver.positiveWord.min):"negativeWord"===t?(i=o.negativeWord,r=TARGETS.driver.negativeWord.min):"managingEmotions"===t?(i=o.managingEmotions,r=TARGETS.driver.managingEmotions.min):"aht"===t?(i=o.aht,r=TARGETS.driver.aht.max,a=" sec"):"acw"===t?(i=o.acw,r=TARGETS.driver.acw.max,a=" sec"):"holdTime"===t?(i=o.holdTime,r=TARGETS.driver.holdTime.max,a=" sec"):"reliability"===t&&(i=o.reliability,r=TARGETS.driver.reliability.max,a=" hrs"),void 0!==i&&void 0!==r&&e.push(`${n}: ${i}${a} (need: ${r}${a})`)});const t=r.includes("reliability"),n=l&&r.some(e=>s[e]>0);h+=n?"REPEAT COACHING - Use NEW wording, different examples, fresh approach. Don't repeat previous phrases:\n":"IMPROVE:\n",e.forEach(e=>h+=`‚Ä¢ ${e}\n`),h+="\nTIPS (bullet format):\n",r.forEach(e=>{h+=`‚Ä¢ ${AREA_NAMES[e]}: ${getRandomTip(e)}\n`}),t&&o.reliability>=16&&(h+="\n(PTOST procedures required - code time in Verint)"),h+='\n\nFORMATTING: Bold only the metric name at the start of each tip (e.g., **Schedule Adherence:** then normal text). Vary phrasing and avoid repeating the same structure. Give concrete, real-world examples. For word choice tips, suggest concise swaps (e.g., "Instead of [X], try [Y]"). No em dashes.'}const f=document.getElementById("customNotes")?.value.trim();f&&(h+=`\n\n${f}`);const E=document.getElementById("startDate")?.value||"",T=document.getElementById("endDate")?.value||"";saveToHistory(t,r,o,E&&T?`${E} to ${T}`:""),document.getElementById("resultName").textContent=t,document.getElementById("aiPrompt").value=h,showOnlySection("resultsSection"),document.getElementById("resultsSection").scrollIntoView({behavior:"smooth",block:"start"})})}function buildConsolidatedMetrics(e,t){const n={scheduleAdherence:{target:TARGETS.driver.scheduleAdherence.min,type:"min",label:"Schedule Adherence",unit:"%"},cxRepOverall:{target:TARGETS.driver.cxRepOverall.min,type:"min",label:"CX Rep Overall",unit:"%"},fcr:{target:TARGETS.driver.fcr.min,type:"min",label:"First Call Resolution",unit:"%"},overallExperience:{target:TARGETS.driver.overallExperience.min,type:"min",label:"Overall Experience",unit:"%"},transfers:{target:TARGETS.driver.transfers.max,type:"max",label:"Transfers",unit:"%"},overallSentiment:{target:TARGETS.driver.overallSentiment.min,type:"min",label:"Overall Sentiment",unit:"%"},positiveWord:{target:TARGETS.driver.positiveWord.min,type:"min",label:"Positive Word Choice",unit:"%"},negativeWord:{target:TARGETS.driver.negativeWord.min,type:"min",label:"Negative Word",unit:"%"},managingEmotions:{target:TARGETS.driver.managingEmotions.min,type:"min",label:"Managing Emotions",unit:"%"},aht:{target:TARGETS.driver.aht.max,type:"max",label:"AHT",unit:"s"},acw:{target:TARGETS.driver.acw.max,type:"max",label:"ACW",unit:"s"},holdTime:{target:TARGETS.driver.holdTime.max,type:"max",label:"Hold Time",unit:"s"},reliability:{target:TARGETS.driver.reliability.max,type:"max",label:"Reliability",unit:" hrs"}},i=[...getAllHistory()[e]||[]].sort((e,t)=>new Date(e.date)-new Date(t.date)),o=i.length>0?i[i.length-1]:null,r={},a={};i.forEach(e=>{e.metrics&&Object.entries(e.metrics).forEach(([e,t])=>{""===t||null==t||isNaN(parseFloat(t))||(r[e]=(r[e]||0)+parseFloat(t),a[e]=(a[e]||0)+1)})});const l={};Object.keys(r).forEach(e=>{l[e]=r[e]/a[e]});const s=[];if(Object.entries(n).forEach(([e,n])=>{const i=t[e];if(""===i||null==i||isNaN(parseFloat(i)))return;const r=parseFloat(i),a="min"===n.type?r>=n.target:r<=n.target,d=o&&o.metrics?o.metrics[e]:void 0,c=""===d||null==d?void 0:parseFloat(d),m=l[e],p=void 0===c||isNaN(c)?null:r-c,u=void 0===m||isNaN(m)?null:r-m;s.push({key:e,label:n.label,value:r,target:n.target,unit:n.unit,meets:a,deltaPrev:p,deltaYtd:u,type:n.type})}),0===s.length)return'<p style="color: #666;">No metrics available to consolidate.</p>';const d=e=>`<td style="padding: 6px 8px; border-bottom: 1px solid #eee;">${e}</td>`;let c='<table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">';return c+='<thead><tr style="background: #f1f3f5; text-align: left;"><th style="padding: 8px;">Metric</th><th style="padding: 8px;">Current</th><th style="padding: 8px;">Target</th><th style="padding: 8px;">Œî Prev</th><th style="padding: 8px;">Œî YTD</th><th style="padding: 8px;">Status</th></tr></thead>',c+="<tbody>",s.forEach(e=>{const t=e.meets?"#28a745":"#dc3545",n=e.meets?"‚úÖ On target":"‚ö†Ô∏è Needs improvement",i=(t,n)=>{if(null==t||isNaN(t))return"";const i="min"===n?t>0:t<0;return`<span style="color: ${i?"#28a745":0===t?"#666":"#dc3545"};">${i?"üìà":0===t?"‚Üí":"üìâ"} ${t>0?"+":""}${t.toFixed(2)}${e.unit}</span>`};c+="<tr>",c+=d(`<strong>${e.label}</strong>`),c+=d(`${e.value}${e.unit}`),c+=d(`${"min"===e.type?"‚â•":"‚â§"}${e.target}${e.unit}`),c+=d(i(e.deltaPrev,e.type)),c+=d(i(e.deltaYtd,e.type)),c+=d(`<span style="color: ${t}; font-weight: 600;">${n}</span>`),c+="</tr>"}),c+="</tbody></table>",c}function aggregateUploadData(){if(!uploadHistory||0===uploadHistory.length)return null;const e={totalUploads:uploadHistory.length,timePeriods:[],totalEmployees:0,employeeCount:{},metricAverages:{},metricsAboveTarget:{},metricsAbovePercent:{}},t=[{id:"scheduleAdherence",target:TARGETS.driver.scheduleAdherence.min,type:"min"},{id:"cxRepOverall",target:TARGETS.driver.cxRepOverall.min,type:"min"},{id:"fcr",target:TARGETS.driver.fcr.min,type:"min"},{id:"overallExperience",target:TARGETS.driver.overallExperience.min,type:"min"},{id:"transfers",target:TARGETS.driver.transfers.max,type:"max"},{id:"overallSentiment",target:TARGETS.driver.overallSentiment.min,type:"min"},{id:"positiveWord",target:TARGETS.driver.positiveWord.min,type:"min"},{id:"negativeWord",target:TARGETS.driver.negativeWord.min,type:"min"},{id:"managingEmotions",target:TARGETS.driver.managingEmotions.min,type:"min"},{id:"aht",target:TARGETS.driver.aht.max,type:"max"},{id:"acw",target:TARGETS.driver.acw.max,type:"max"},{id:"holdTime",target:TARGETS.driver.holdTime.max,type:"max"},{id:"reliability",target:TARGETS.driver.reliability.max,type:"max"}];return t.forEach(t=>{e.metricAverages[t.id]={sum:0,count:0,values:[]},e.metricsAboveTarget[t.id]=0}),uploadHistory.forEach(n=>{e.timePeriods.push(n.timePeriod),e.totalEmployees+=n.employeeCount,(n.employeeMetrics||[]).forEach(n=>{e.employeeCount[n.name]=(e.employeeCount[n.name]||0)+1,t.forEach(t=>{const i=n[t.id];if(void 0!==i&&""!==i&&!isNaN(parseFloat(i))){const n=parseFloat(i);e.metricAverages[t.id].sum+=n,e.metricAverages[t.id].count++,e.metricAverages[t.id].values.push(n);("min"===t.type?n>=t.target:n<=t.target)&&e.metricsAboveTarget[t.id]++}})})}),t.forEach(t=>{const n=e.metricAverages[t.id];if(n.count>0){const i=n.sum/n.count;e.metricAverages[t.id].average=i.toFixed(2),e.metricsAbovePercent[t.id]=(e.metricsAboveTarget[t.id]/n.count*100).toFixed(0)}}),e}function generateExecutiveSummaryPrompt(){const e=aggregateUploadData();if(!e)return"No data available yet. Please upload employee data first.";const t=[],n={scheduleAdherence:"Schedule Adherence",cxRepOverall:"Customer Experience",fcr:"First Call Resolution",overallExperience:"Overall Experience",transfers:"Transfers",overallSentiment:"Overall Sentiment",positiveWord:"Positive Word Choice",negativeWord:"Negative Word Choice",managingEmotions:"Managing Emotions",aht:"Average Handle Time",acw:"After Call Work",holdTime:"Hold Time",reliability:"Reliability"};t.push("Team Performance Summary"),t.push(`Time Periods Analyzed: ${e.timePeriods.join(", ")}`),t.push(`Total Data Points: ${e.totalUploads} uploads`),t.push(`Unique Employees Coached: ${Object.keys(e.employeeCount).length}`),t.push(`Total Observations: ${e.totalEmployees} employee-period records`),t.push(""),t.push("Key Performance Metrics:"),Object.keys(e.metricAverages).forEach(i=>{const o=e.metricAverages[i];if(o.count>0){const r=e.metricsAbovePercent[i],a=n[i];t.push(`‚Ä¢ ${a}: Average ${o.average}, ${r}% of team meeting target`)}});return`Write a professional 150-200 word executive summary for my manager based on this team performance data:\n\n${t.join("\n")}\n\nInclude: overall team health, top 3 strengths, top 3 areas for improvement, and one recommended focus for next period. Keep tone professional and data-driven.`}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initApp):initApp();