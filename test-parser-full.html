<!DOCTYPE html>
<html>
<head>
    <title>Full Parser Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        textarea { width: 100%; height: 200px; margin: 10px 0; font-family: monospace; }
        button { padding: 10px 20px; font-size: 16px; background: #28a745; color: white; border: none; cursor: pointer; }
        .output { white-space: pre-wrap; background: #f0f0f0; padding: 10px; margin-top: 10px; font-family: monospace; font-size: 12px; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>PowerBI Data Parser - Test Environment</h1>
    <p>Test the complete parsing logic before deploying to production.</p>
    
    <textarea id="input" placeholder="Paste PowerBI data here (with headers)..."></textarea>
    <button onclick="testParse()">Parse & Analyze</button>
    
    <div id="output" class="output"></div>
    
    <script>
        // Exact copy of production patterns
        const HEADER_PATTERNS = [
            { name: 'EMPLOYEE_NAME', patterns: ['name(last,first)'] },
            { name: 'TOTAL_CALLS', patterns: ['totalcallsanswered'] },
            { name: 'TRANSFERS_PERCENT', patterns: ['transfers%'] },
            { name: 'AHT_SECONDS', patterns: ['aht'] },
            { name: 'TALK_SECONDS', patterns: ['talk'] },
            { name: 'HOLD_SECONDS', patterns: ['hold'] },
            { name: 'ACW_SECONDS', patterns: ['acw'] },
            { name: 'ADHERENCE_PERCENT', patterns: ['adherence%'] },
            { name: 'EMOTIONS_PERCENT', patterns: ['manageemotionsscore%'] },
            { name: 'NEGATIVE_WORD_PERCENT', patterns: ['avoidnegativewordscore%'] },
            { name: 'POSITIVE_WORD_PERCENT', patterns: ['positivewordscore%'] },
            { name: 'SENTIMENT_PERCENT', patterns: ['overallsentimentscore%'] },
            { name: 'FCR_PERCENT', patterns: ['fcr%'] },
            { name: 'CX_REP_OVERALL', patterns: ['repsat%'] },
            { name: 'OVERALL_EXPERIENCE', patterns: ['overallexperience%'] },
            { name: 'SURVEY_TOTAL', patterns: ['oesurveytotal'] },
            { name: 'RELIABILITY_HOURS', patterns: ['reliabilityhrs'] }
        ];

        function testParse() {
            const text = document.getElementById('input').value;
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            
            let output = '';
            
            if (lines.length < 2) {
                output = '<span class="error">❌ Need at least header row + 1 data row</span>\n';
                document.getElementById('output').innerHTML = output;
                return;
            }
            
            // Split by 2+ spaces
            const separator = /\s{2,}/;
            const headers = lines[0].split(separator).map(h => h.trim());
            
            output += `<span class="success">✅ Found ${headers.length} header columns</span>\n\n`;
            output += '=== HEADERS ===\n';
            headers.forEach((h, i) => {
                const lower = h.toLowerCase();
                const noSpaces = lower.replace(/\s+/g, '');
                output += `[${i}]: "${h}"\n`;
                output += `     lowercase: "${lower}"\n`;
                output += `     no spaces: "${noSpaces}"\n`;
            });
            
            // Try to map headers
            output += '\n=== MAPPING ATTEMPT ===\n';
            const mapping = {};
            const usedIndices = new Set();
            
            for (const { name, patterns } of HEADER_PATTERNS) {
                for (let i = 0; i < headers.length; i++) {
                    if (usedIndices.has(i)) continue;
                    
                    // CRITICAL: Remove spaces for matching (just like production)
                    const header = headers[i].toLowerCase().replace(/\s+/g, '');
                    const matchedPattern = patterns.find(pattern => header.includes(pattern));
                    
                    if (matchedPattern) {
                        mapping[name] = i;
                        usedIndices.add(i);
                        output += `<span class="success">✅ [${i}] "${headers[i]}" -> ${name} (pattern: "${matchedPattern}")</span>\n`;
                        break;
                    }
                }
            }
            
            // Show unmapped
            const unmapped = headers.filter((h, i) => !usedIndices.has(i));
            if (unmapped.length > 0) {
                output += `\n<span class="warning">⚠️ Unmapped columns: ${unmapped.join(', ')}</span>\n`;
            }
            
            // Check if critical fields are mapped
            output += '\n=== VALIDATION ===\n';
            if (mapping['EMPLOYEE_NAME'] !== undefined) {
                output += '<span class="success">✅ EMPLOYEE_NAME mapped</span>\n';
            } else {
                output += '<span class="error">❌ EMPLOYEE_NAME not mapped</span>\n';
            }
            
            if (mapping['ADHERENCE_PERCENT'] !== undefined) {
                output += '<span class="success">✅ ADHERENCE_PERCENT mapped</span>\n';
            } else {
                output += '<span class="warning">⚠️ ADHERENCE_PERCENT not mapped</span>\n';
            }
            
            const mappedCount = Object.keys(mapping).length;
            output += `\n<span class="success">Total mapped: ${mappedCount} / ${HEADER_PATTERNS.length}</span>\n`;
            
            // Try parsing first data row
            if (lines.length > 1 && mapping['EMPLOYEE_NAME'] !== undefined) {
                output += '\n=== FIRST DATA ROW ===\n';
                const cells = lines[1].split(separator).map(c => c.trim());
                output += `Total cells: ${cells.length}\n`;
                output += `Name: "${cells[mapping['EMPLOYEE_NAME']]}"\n`;
                
                if (mapping['TRANSFERS_PERCENT'] !== undefined) {
                    output += `Transfers: "${cells[mapping['TRANSFERS_PERCENT']]}"\n`;
                }
                if (mapping['TOTAL_CALLS'] !== undefined) {
                    output += `Total Calls: "${cells[mapping['TOTAL_CALLS']]}"\n`;
                }
                if (mapping['ADHERENCE_PERCENT'] !== undefined) {
                    output += `Adherence: "${cells[mapping['ADHERENCE_PERCENT']]}"\n`;
                }
            }
            
            document.getElementById('output').innerHTML = output;
        }
    </script>
</body>
</html>
