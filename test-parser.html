<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Parser Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            margin: 10px 0;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 4px;
        }
        button:hover {
            background: #1976D2;
        }
        #results {
            margin-top: 20px;
        }
        .employee-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            background: #f9f9f9;
        }
        .employee-name {
            font-weight: bold;
            font-size: 18px;
            color: #2196F3;
            margin-bottom: 10px;
        }
        .metric {
            display: inline-block;
            margin: 5px 10px 5px 0;
            padding: 5px 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .label {
            font-weight: bold;
            color: #666;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #dc3545;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        #console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .console-log {
            margin: 2px 0;
        }
        .console-warn {
            color: #ffc107;
        }
        .console-error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <h1>üìã Data Parser Test Tool</h1>
    <p>Paste your PowerBI data for each period and click Parse to compare:</p>
    
    <h3>Week of Jan 4-10, 2026</h3>
    <textarea id="weekData" placeholder="Paste week data here (including header row)..."></textarea>
    <button onclick="parseWeekData()" style="margin-top:10px;">üìä Parse Data</button>
    
    <h3>December 1-31, 2025</h3>
    <textarea id="monthData" placeholder="Paste December data here (including header row)..."></textarea>
    <button onclick="parseMonthData()">Parse December Data</button>
    
    <div id="console"></div>
    <button id="copyConsoleBtn" onclick="copyConsoleOutput()" style="margin-top: 10px;">üìã Copy Console Output</button>
    <div id="results"></div>
    <button id="copyBtn" onclick="copyResults()" style="display:none; margin-top: 10px;">üìã Copy Results to Clipboard</button>
    
    <script>
        let allParsedData = [];
        
        function copyResults() {
            const output = JSON.stringify(allParsedData, null, 2);
            navigator.clipboard.writeText(output).then(() => {
                alert('‚úÖ Results copied to clipboard!');
            }).catch(err => {
                alert('‚ùå Failed to copy: ' + err);
            });
        }
    
        function copyConsoleOutput() {
            const output = consoleOutput.map(log => log.message).join('\n');
            navigator.clipboard.writeText(output).then(() => {
                alert('‚úÖ Console output copied to clipboard!');
            }).catch(err => {
                alert('‚ùå Failed to copy: ' + err);
            });
        }
        
        // Capture console logs
        const consoleOutput = [];
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        console.log = function(...args) {
            consoleOutput.push({type: 'log', message: args.join(' ')});
            originalLog.apply(console, args);
        };
        console.warn = function(...args) {
            consoleOutput.push({type: 'warn', message: args.join(' ')});
            originalWarn.apply(console, args);
        };
        console.error = function(...args) {
            consoleOutput.push({type: 'error', message: args.join(' ')});
            originalError.apply(console, args);
        };
        
        function displayConsole() {
            const consoleDiv = document.getElementById('console');
            consoleDiv.innerHTML = '<h3>Console Output:</h3>';
            consoleOutput.forEach(log => {
                const div = document.createElement('div');
                div.className = `console-log console-${log.type}`;
                div.textContent = log.message;
                consoleDiv.appendChild(div);
            });
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        // Smart PowerBI row parser
        function parsePowerBIRow(row) {
            // Normalize weird PowerBI spaces (including non-breaking spaces)
            row = row.replace(/\u00A0/g, ' ').trim();
            
            // Match: name (stops at first digit, N/A, or (Blank)) + start of first metric
            const match = row.match(/^(.+?)\s+(?=(\(?\d|N\/A|\(Blank\)))/);
            
            if (!match) {
                throw new Error(`Row does not match expected format: "${row.substring(0, 50)}..."`);
            }
            
            const name = match[1].trim();
            const rest = row.slice(match[0].length).trim();
            
            // Split the metrics by any whitespace (1+ spaces or tabs)
            let metrics = rest.split(/\s+/);
            
            // Normalize values: handle (Blank), N/A, percentages, numbers
            metrics = metrics.map(val => {
                if (val === '(Blank)' || val === 'N/A') return null;
                val = val.replace(/,/g, '');
                if (val.endsWith('%')) return parseFloat(val);
                if (!isNaN(val) && val !== '') return Number(val);
                return val;
            });
            
            return [name, ...metrics];
        }
        
        // Copy the parsing logic from script.js
        const CANONICAL_SCHEMA = {
            EMPLOYEE_NAME: 'EMPLOYEE_NAME',
            TOTAL_CALLS: 'TOTAL_CALLS',
            ADHERENCE_PERCENT: 'ADHERENCE_PERCENT',
            CX_REP_OVERALL: 'CX_REP_OVERALL',
            FCR_PERCENT: 'FCR_PERCENT',
            OVERALL_EXPERIENCE: 'OVERALL_EXPERIENCE',
            TRANSFERS_PERCENT: 'TRANSFERS_PERCENT',
            AHT_SECONDS: 'AHT_SECONDS',
            TALK_SECONDS: 'TALK_SECONDS',
            ACW_SECONDS: 'ACW_SECONDS',
            HOLD_SECONDS: 'HOLD_SECONDS',
            RELIABILITY_HOURS: 'RELIABILITY_HOURS',
            SENTIMENT_PERCENT: 'SENTIMENT_PERCENT',
            POSITIVE_WORD_PERCENT: 'POSITIVE_WORD_PERCENT',
            NEGATIVE_WORD_PERCENT: 'NEGATIVE_WORD_PERCENT',
            EMOTIONS_PERCENT: 'EMOTIONS_PERCENT',
            SURVEY_TOTAL: 'SURVEY_TOTAL'
        };

        function mapHeadersToSchema(headers) {
            const mapping = {};
            
            headers.forEach((header, idx) => {
                const h = header.toLowerCase().replace(/[^a-z0-9]/g, '');
                
                if (h.includes('name') || h.includes('employee')) {
                    mapping[CANONICAL_SCHEMA.EMPLOYEE_NAME] = idx;
                } else if (h === 'totalcallsanswered' || h === 'totalcalls') {
                    mapping[CANONICAL_SCHEMA.TOTAL_CALLS] = idx;
                } else if (h.includes('adherence')) {
                    mapping[CANONICAL_SCHEMA.ADHERENCE_PERCENT] = idx;
                } else if (h.includes('cxrepoverall') || h === 'cxrepoverall') {
                    mapping[CANONICAL_SCHEMA.CX_REP_OVERALL] = idx;
                } else if (h.includes('fcr') || h.includes('firstcall')) {
                    mapping[CANONICAL_SCHEMA.FCR_PERCENT] = idx;
                } else if (h.includes('overallexperience')) {
                    mapping[CANONICAL_SCHEMA.OVERALL_EXPERIENCE] = idx;
                } else if (h.includes('transfer')) {
                    mapping[CANONICAL_SCHEMA.TRANSFERS_PERCENT] = idx;
                } else if (h.includes('avghandletime') || h === 'aht') {
                    mapping[CANONICAL_SCHEMA.AHT_SECONDS] = idx;
                } else if (h.includes('avgtalktime' || h.includes('talktime'))) {
                    mapping[CANONICAL_SCHEMA.TALK_SECONDS] = idx;
                } else if (h.includes('avgacw') || (h.includes('after') && h.includes('call'))) {
                    mapping[CANONICAL_SCHEMA.ACW_SECONDS] = idx;
                } else if (h.includes('avgholdtime') || h.includes('holdtime')) {
                    mapping[CANONICAL_SCHEMA.HOLD_SECONDS] = idx;
                } else if (h.includes('reliability')) {
                    mapping[CANONICAL_SCHEMA.RELIABILITY_HOURS] = idx;
                } else if (h.includes('overallsentiment') || h === 'sentiment') {
                    mapping[CANONICAL_SCHEMA.SENTIMENT_PERCENT] = idx;
                } else if (h.includes('positiveword') || h === 'positiveword') {
                    mapping[CANONICAL_SCHEMA.POSITIVE_WORD_PERCENT] = idx;
                } else if (h.includes('avoidnegativeword') || h.includes('negativeword')) {
                    mapping[CANONICAL_SCHEMA.NEGATIVE_WORD_PERCENT] = idx;
                } else if (h.includes('managingemotions') || h.includes('emotions')) {
                    mapping[CANONICAL_SCHEMA.EMOTIONS_PERCENT] = idx;
                } else if (h.includes('surveytotal') || h === 'surveys') {
                    mapping[CANONICAL_SCHEMA.SURVEY_TOTAL] = idx;
                }
            });
            
            console.log('üìã Column Mapping:', mapping);
            return mapping;
        }

        function parsePercentage(str) {
            if (!str || str === '') return '';
            const num = parseFloat(str.toString().replace('%', ''));
            return isNaN(num) ? '' : num;
        }

        function parseSurveyPercentage(str) {
            if (!str || str === '') return '';
            const num = parseFloat(str.toString().replace('%', ''));
            return isNaN(num) ? '' : num;
        }

        function parseSeconds(str) {
            if (!str || str === '') return '';
            const num = parseInt(str);
            return isNaN(num) ? '' : num;
        }

        function parseHours(str) {
            if (!str || str === '') return '';
            const num = parseFloat(str);
            return isNaN(num) ? '' : num;
        }

        function parsePastedData(pastedText) {
            consoleOutput.length = 0; // Clear previous logs
            
            const lines = pastedText.split('\n').map(line => line.trim()).filter(line => line);
            
            if (lines.length < 2) {
                throw new Error('Data appears incomplete. Please paste header row and data rows.');
            }
            
            console.log('üìã Using Smart PowerBI Parser');
            
            // Skip the header line - we don't need to parse it since we use positional logic
            const headerLine = lines[0];
            const hasNameHeader = headerLine.toLowerCase().includes('name');
            
            if (!hasNameHeader) {
                throw new Error('‚ùå Header row not found! Make sure to include the header row at the top of your pasted data.');
            }
            
            console.log('‚úÖ Header detected, parsing data rows...');
            
            const employees = [];
            
            for (let i = 1; i < lines.length; i++) {
                const rawRow = lines[i];
                
                if (!rawRow.trim()) continue; // Skip empty lines
                
                let cells;
                try {
                    // Use the smart PowerBI row parser
                    const parsed = parsePowerBIRow(rawRow);
                    cells = parsed;
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Skipping row ${i}: ${error.message}`);
                    continue;
                }
                
                // Validate we have 22 cells
                if (cells.length !== 22) {
                    if (cells.length < 22) {
                        while (cells.length < 22) {
                            cells.push(null);
                        }
                    } else {
                        cells = cells.slice(0, 22);
                    }
                }
                
                const rawName = cells[0] || '';
                const nameMatch = rawName.match(/^([^,]+),\s*(.+)$/);
                
                if (!nameMatch) {
                    console.warn('‚ö†Ô∏è Skipping row - no valid name found:', rawName);
                    continue;
                }
                
                const lastName = nameMatch[1].trim();
                const firstName = nameMatch[2].trim();
                const displayName = `${firstName} ${lastName}`;
                
                console.log(`\n‚úÖ Parsing: ${displayName}`);
                console.log('  Total cells:', cells.length);
                
                // Direct positional access (column 0-21)
                const getCell = (colIndex) => {
                    return cells[colIndex] || '';
                };
                
                const surveyTotalRaw = getCell(17); // OE Survey Total
                const totalCallsRaw = getCell(1);   // TotalCallsAnswered
                
                const surveyTotal = Number.isInteger(parseInt(surveyTotalRaw, 10)) ? parseInt(surveyTotalRaw, 10) : 0;
                let totalCalls = Number.isInteger(parseInt(totalCallsRaw, 10)) ? parseInt(totalCallsRaw, 10) : 0;
                
                const employeeData = {
                    name: displayName,
                    firstName: firstName,
                    scheduleAdherence: parsePercentage(getCell(7)) || 0,      // Adherence%
                    cxRepOverall: surveyTotal > 0 ? parseSurveyPercentage(getCell(14)) : '',  // RepSat%
                    fcr: surveyTotal > 0 ? parseSurveyPercentage(getCell(12)) : '',           // FCR%
                    overallExperience: surveyTotal > 0 ? parseSurveyPercentage(getCell(16)) : '', // OverallExperience%
                    transfers: parsePercentage(getCell(2)) || 0,              // Transfers%
                    aht: parseSeconds(getCell(3)) || '',                      // AHT
                    talkTime: parseSeconds(getCell(4)) || '',                 // Talk
                    acw: parseSeconds(getCell(6)) || '',                      // ACW
                    holdTime: parseSeconds(getCell(5)) || '',                 // Hold
                    reliability: parseHours(getCell(21)) || 0,                // ReliabilityHours
                    overallSentiment: parsePercentage(getCell(11)) || '',     // OverallSentimentScore%
                    positiveWord: parsePercentage(getCell(10)) || '',         // PositiveWordScore%
                    negativeWord: parsePercentage(getCell(9)) || '',          // AvoidNegativeWordScore%
                    managingEmotions: parsePercentage(getCell(8)) || '',      // ManageEmotionsScore%
                    surveyTotal: surveyTotal,
                    totalCalls: totalCalls
                };
                
                // FIX #1: Sanity validation
                if (employeeData.surveyTotal > employeeData.totalCalls && employeeData.totalCalls > 0) {
                    console.warn(`‚ö†Ô∏è DATA INTEGRITY ISSUE for ${displayName}: surveyTotal (${employeeData.surveyTotal}) > totalCalls (${employeeData.totalCalls}). Invalidating totalCalls.`);
                    employeeData.totalCalls = 0;
                }
                
                employees.push(employeeData);
            }
            
            console.log(`‚úÖ Parsed ${employees.length} employees`);
            
            return employees;
        }

        function strictParsePastedData(pastedText, expectedColumns) {
            consoleOutput.length = 0;
            const lines = pastedText.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length < 2) throw new Error('Data appears incomplete.');
            // Split by 2+ spaces (PowerBI delimiter)
            const separator = /\s{2,}/;
            const headers = lines[0].split(separator).map(h => h.trim());
            const employees = [];
            for (let i = 1; i < lines.length; i++) {
                const row = lines[i];
                const cells = row.split(separator).map(c => c.trim());
                
                // Anchor on Last, First
                const rawName = cells[0] || '';
                const nameMatch = rawName.match(/^([^,]+,\s*\S+)/);
                if (!nameMatch) {
                    console.warn('‚ö†Ô∏è Skipping row - no valid name found:', rawName);
                    continue;
                }
                const name = nameMatch[1];
                let fields = cells.slice(1).map(val => (val === '(Blank)' || val === 'N/A') ? null : val);
                
                // Insert nulls if missing fields
                while (fields.length < headers.length - 1) fields.push(null);
                // Truncate if too many
                if (fields.length > headers.length - 1) fields = fields.slice(0, headers.length - 1);
                employees.push({ name, fields });
            }
            return { headers, employees };
        }

        function displayResults(employees, title) {
            const resultsDiv = document.getElementById('results');
            document.getElementById('copyBtn').style.display = 'block';
            
            allParsedData.push({
                period: title,
                employeeCount: employees.length,
                employees: employees
            });
            
            const section = document.createElement('div');
            section.innerHTML = `<h2>${title} - ‚úÖ Parsed ${employees.length} Employees</h2>`;
            
            employees.forEach(emp => {
                const card = document.createElement('div');
                card.className = 'employee-card';
                
                card.innerHTML = `
                    <div class="employee-name">${emp.name}</div>
                    <div class="metric"><span class="label">Total Calls:</span> ${emp.totalCalls}</div>
                    <div class="metric"><span class="label">Survey Total:</span> ${emp.surveyTotal}</div>
                    <div class="metric"><span class="label">Adherence:</span> ${emp.scheduleAdherence}%</div>
                    <div class="metric"><span class="label">CX Rep:</span> ${emp.cxRepOverall}%</div>
                    <div class="metric"><span class="label">FCR:</span> ${emp.fcr}%</div>
                    <div class="metric"><span class="label">Experience:</span> ${emp.overallExperience}%</div>
                    <div class="metric"><span class="label">Transfers:</span> ${emp.transfers}%</div>
                    <div class="metric"><span class="label">AHT:</span> ${emp.aht}s</div>
                    <div class="metric"><span class="label">ACW:</span> ${emp.acw}s</div>
                    <div class="metric"><span class="label">Hold:</span> ${emp.holdTime}s</div>
                    <div class="metric"><span class="label">Reliability:</span> ${emp.reliability}h</div>
                    <div class="metric"><span class="label">Sentiment:</span> ${emp.overallSentiment}%</div>
                    <div class="metric"><span class="label">Positive:</span> ${emp.positiveWord}%</div>
                    <div class="metric"><span class="label">Negative:</span> ${emp.negativeWord}%</div>
                    <div class="metric"><span class="label">Emotions:</span> ${emp.managingEmotions}%</div>
                `;
                
                section.appendChild(card);
            });
            
            resultsDiv.appendChild(section);
        }
        
        function parseWeekData() {
            const pastedData = document.getElementById('weekData').value;
            
            if (!pastedData.trim()) {
                allParsedData = [];
                alert('Please paste week data first!');
                return;
            }
            
            try {
                document.getElementById('results').innerHTML = '';
                consoleOutput.length = 0;
                
                const employees = parsePastedData(pastedData);
                displayResults(employees, 'üìÖ Week of Jan 4-10');
                displayConsole();
                
            } catch (error) {
                consoleOutput.push({type: 'error', message: '‚ùå ERROR: ' + error.message});
                consoleOutput.push({type: 'error', message: 'Stack: ' + error.stack});
                document.getElementById('results').innerHTML = `<div class="error"><strong>Week Error:</strong> ${error.message}<br><br><pre>${error.stack}</pre></div>`;
                displayConsole();
            }
        }
        
        function parseMonthData() {
            const pastedData = document.getElementById('monthData').value;
            
            if (!pastedData.trim()) {
                alert('Please paste December data first!');
                return;
            }
            
            try {
                if (document.getElementById('results').innerHTML === '') {
                    consoleOutput.length = 0;
                }
                
                const employees = parsePastedData(pastedData);
                displayResults(employees, 'üìÖ December 2025');
                displayConsole();
                
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `<strong>December Error:</strong> ${error.message}`;
                document.getElementById('results').appendChild(errorDiv);
                displayConsole();
            }
        }
        
        function smartParsePastedData(pastedText) {
            consoleOutput.length = 0;
            const lines = pastedText.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length < 2) throw new Error('Data appears incomplete.');
            
            const dataLines = lines.slice(1);
            const employees = [];
            
            dataLines.forEach((line, idx) => {
                const nameMatch = line.match(/^([^,]+,\s*\S+)/);
                if (!nameMatch) {
                    console.warn('‚ö†Ô∏è Row ' + (idx + 2) + ': No valid name found');
                    return;
                }
                
                const name = nameMatch[1];
                const restOfLine = line.slice(nameMatch[0].length).trim();
                let values = restOfLine.split(/\s+/);
                
                // Rejoin percentages that were split (e.g., "92.5" and "%" ‚Üí "92.5%")
                values = values.reduce((acc, val, i) => {
                    if (val === '%' && acc.length > 0 && !acc[acc.length - 1].includes('%')) {
                        acc[acc.length - 1] += '%';
                    } else {
                        acc.push(val);
                    }
                    return acc;
                }, []);
                
                const employee = { name, fields: [name] };
                values.forEach((val, i) => {
                    if (i < 25) {
                        employee.fields.push((val === '(Blank)' || val === 'N/A') ? null : val);
                    }
                });
                while (employee.fields.length < 26) employee.fields.push(null);
                employees.push(employee);
            });
            
            const columnNames = ['Name', 'TotalCallsAnswered', 'Transfers%', 'AHT', 'Talk', 'Hold', 'ACW', 'Adherence%', 'ManageEmotionsScore%', 'AvoidNegativeWordScore%', 'PositiveWordScore%', 'OverallSentimentScore%', 'FCR%', 'OverallFCRTotal', 'RepSat%', 'OverallRepTotal', 'OverallExperience%', 'OE', 'Survey', 'Total', 'TotalIn-OfficeShrink%', 'TotalOOOShrink%', 'TotalShrinkage%', 'Reliability', 'Hrs'];
            return { headers: columnNames, employees: employees };
        }
        
        function runSmartParse() {
            const pastedData = document.getElementById('weekData').value;
            if (!pastedData.trim()) {
                alert('Please paste week data first!');
                return;
            }
            consoleOutput.length = 0;
            try {
                const result = smartParsePastedData(pastedData);
                consoleOutput.push({type: 'log', message: '--- Smart Parse Results ---'});
                consoleOutput.push({type: 'log', message: 'Headers: ' + result.headers.join(' | ')});
                result.employees.forEach(emp => {
                    consoleOutput.push({type: 'log', message: emp.fields.map(f => f === null ? '(null)' : f).join(' | ')});
                });
                displayConsole();
                let html = `<h2>Smart Parse Results</h2><div><b>Headers:</b> ${result.headers.join(' | ')}</div>`;
                result.employees.forEach(emp => {
                    html += `<div class='employee-card'><b>${emp.fields[0]}</b><br>${emp.fields.slice(1).map((f, i) => `<span class='metric'><span class='label'>${result.headers[i+1]||''}:</span> ${f===null?'(null)':f}</span>`).join('')}</div>`;
                });
                document.getElementById('results').innerHTML = html;
            } catch (error) {
                consoleOutput.push({type: 'error', message: 'Error: ' + error.message});
                displayConsole();
            }
        }

        function runStrictTest() {
            const pastedData = document.getElementById('weekData').value;
            if (!pastedData.trim()) {
                alert('Please paste week data first!');
                return;
            }
            consoleOutput.length = 0;
            const lines = pastedData.split('\n').map(line => line.trim()).filter(line => line);
            const expectedColumns = lines[0].replace(/\s+/g, ' ').split(' ').length;
            const result = strictParsePastedData(pastedData, expectedColumns);
            // Show results
            let html = `<h2>Strict Parse Results</h2><div><b>Headers:</b> ${result.headers.join(' | ')}</div>`;
            result.employees.forEach(emp => {
                html += `<div class='employee-card'><b>${emp.name}</b><br>${emp.fields.map((f, i) => `<span class='metric'><span class='label'>${result.headers[i+1]||''}:</span> ${f===null?'(null)':f}</span>`).join('')}</div>`;
            });
            document.getElementById('results').innerHTML = html;
            
            // Log strict parse results to console output for easy copying
            consoleOutput.push({type: 'log', message: '--- Strict Parse Results ---'});
            consoleOutput.push({type: 'log', message: 'Headers: ' + result.headers.join(' | ')});
            result.employees.forEach(emp => {
                consoleOutput.push({type: 'log', message: emp.name + ' | ' + emp.fields.map(f => f === null ? '(null)' : f).join(' | ')});
            });
            displayConsole();
        }
    </script>
</body>
</html>
